<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cartographie Comptes Privil√©gi√©s ISO27001</title>
<style>
    :root {
        --primary: #667eea;
        --primary-dark: #5a67d8;
        --secondary: #764ba2;
        --success: #48bb78;
        --danger: #f56565;
        --warning: #ed8936;
        --info: #4299e1;
        --dark: #2d3748;
        --light: #f7fafc;
        --gray: #718096;
        --border: #e2e8f0;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    * {
        box-sizing: border-box;
    }

    body {
        margin: 0;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        overflow: hidden;
        color: var(--dark);
    }

    .header {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid var(--border);
        padding: 1rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: var(--shadow);
        z-index: 1000;
        position: relative;
    }

    .logo {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 1.4rem;
        font-weight: 700;
        color: var(--primary);
    }

    .logo::before {
        content: "üõ°Ô∏è";
        font-size: 2rem;
        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
    }

    .toolbar {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        flex-wrap: wrap;
    }

    .btn {
        background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        border: none;
        padding: 0.75rem 1.25rem;
        border-radius: 10px;
        color: white;
        font-weight: 600;
        cursor: pointer;
        box-shadow: var(--shadow);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
        text-decoration: none;
        position: relative;
        overflow: hidden;
    }

    .btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s;
    }

    .btn:hover {
        transform: translateY(-2px) scale(1.02);
        box-shadow: var(--shadow-lg);
    }

    .btn:hover::before {
        left: 100%;
    }

    .btn:active {
        transform: translateY(0) scale(0.98);
    }

    .btn-success {
        background: linear-gradient(135deg, var(--success), #38a169);
    }

    .btn-warning {
        background: linear-gradient(135deg, var(--warning), #dd6b20);
    }

    .btn-danger {
        background: linear-gradient(135deg, var(--danger), #e53e3e);
    }

    .btn-secondary {
        background: linear-gradient(135deg, var(--gray), #4a5568);
    }

    .main-container {
        display: flex;
        height: calc(100vh - 90px);
        position: relative;
    }

    .sidebar {
        width: 320px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(15px);
        border-right: 1px solid var(--border);
        padding: 1.5rem;
        overflow-y: auto;
        box-shadow: var(--shadow);
        transition: transform 0.3s ease;
        z-index: 100;
    }

    .sidebar.collapsed {
        transform: translateX(-300px);
    }

    .sidebar-toggle {
        position: absolute;
        top: 1rem;
        right: -45px;
        background: var(--primary);
        color: white;
        border: none;
        width: 45px;
        height: 45px;
        border-radius: 0 12px 12px 0;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: var(--shadow);
        z-index: 101;
        transition: all 0.3s ease;
        font-size: 1.2rem;
    }

    .sidebar-toggle:hover {
        background: var(--primary-dark);
        transform: scale(1.05);
    }

    .stats-panel {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(247, 250, 252, 0.8));
        backdrop-filter: blur(10px);
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: var(--shadow);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .stats-panel h3 {
        margin: 0 0 1rem 0;
        color: var(--primary);
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }

    .stat-item {
        text-align: center;
        padding: 1rem;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.8), rgba(237, 242, 247, 0.6));
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .stat-item:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow);
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 800;
        color: var(--primary);
        display: block;
        text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .stat-label {
        font-size: 0.85rem;
        color: var(--gray);
        margin-top: 0.25rem;
        font-weight: 500;
    }

    .controls-section {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(247, 250, 252, 0.8));
        backdrop-filter: blur(10px);
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: var(--shadow);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .controls-section h3 {
        margin: 0 0 1rem 0;
        color: var(--primary);
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .control-group {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .canvas-container {
        flex: 1;
        position: relative;
        background: radial-gradient(circle at 25% 25%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                    radial-gradient(circle at 75% 75%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                    linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
        backdrop-filter: blur(5px);
        overflow: hidden;
        cursor: grab;
        border-radius: 0;
    }

    .canvas-container:active {
        cursor: grabbing;
    }

    #container {
        width: 100%;
        height: 100%;
        position: relative;
    }

    svg {
        width: 100%;
        height: 100%;
        background: transparent;
    }

    .server {
        fill: url(#serverGradient);
        stroke: #8e44ad;
        stroke-width: 2;
        filter: drop-shadow(0 4px 8px rgba(142, 68, 173, 0.3));
        transition: all 0.3s ease;
    }

    .server:hover {
        filter: drop-shadow(0 6px 12px rgba(142, 68, 173, 0.4));
        transform: scale(1.02);
    }

    .account {
        fill: url(#accountGradient);
        stroke: #2980b9;
        stroke-width: 2;
        filter: drop-shadow(0 4px 8px rgba(41, 128, 185, 0.3));
        transition: all 0.3s ease;
    }

    .account:hover {
        filter: drop-shadow(0 6px 12px rgba(41, 128, 185, 0.4));
        transform: scale(1.02);
    }

    .identity {
        fill: url(#identityGradient);
        stroke: #27ae60;
        stroke-width: 2;
        filter: drop-shadow(0 4px 8px rgba(39, 174, 96, 0.3));
        transition: all 0.3s ease;
    }

    .identity:hover {
        filter: drop-shadow(0 6px 12px rgba(39, 174, 96, 0.4));
        transform: scale(1.02);
    }

    .label {
        font-size: 12px;
        fill: white;
        pointer-events: none;
        font-weight: 600;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.7);
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(8px);
        justify-content: center;
        align-items: center;
        z-index: 2000;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .modal-content {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(247, 250, 252, 0.9));
        backdrop-filter: blur(20px);
        padding: 2rem;
        border-radius: 20px;
        width: min(90vw, 480px);
        max-height: 85vh;
        overflow-y: auto;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        animation: slideIn 0.3s ease;
        position: relative;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-30px) scale(0.9);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    .modal-content h3 {
        margin: 0 0 1.5rem 0;
        color: var(--primary);
        font-size: 1.4rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--border);
    }

    .modal-content label {
        display: block;
        margin: 1.25rem 0 0.5rem 0;
        font-weight: 600;
        color: var(--dark);
        font-size: 0.95rem;
    }

    .modal-content input,
    .modal-content select,
    .modal-content textarea {
        width: 100%;
        padding: 0.875rem;
        border: 2px solid var(--border);
        border-radius: 10px;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(5px);
    }

    .modal-content input:focus,
    .modal-content select:focus,
    .modal-content textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        background: rgba(255, 255, 255, 0.95);
    }

    .modal-content button {
        margin: 1.5rem 0.5rem 0.5rem 0;
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9rem;
    }

    .modal-content button:first-of-type {
        background: linear-gradient(135deg, var(--success), #38a169);
        color: white;
        box-shadow: var(--shadow);
    }

    .modal-content button:first-of-type:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .modal-content button:last-of-type {
        background: linear-gradient(135deg, var(--gray), #4a5568);
        color: white;
        box-shadow: var(--shadow);
    }

    .modal-content button:last-of-type:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .zoom-controls {
        position: absolute;
        bottom: 2rem;
        right: 2rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        z-index: 100;
    }

    .zoom-btn {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border: 1px solid var(--border);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.4rem;
        font-weight: 700;
        color: var(--primary);
        box-shadow: var(--shadow);
        transition: all 0.2s ease;
    }

    .zoom-btn:hover {
        transform: scale(1.1);
        background: white;
        color: var(--primary-dark);
    }

    .help-tooltip {
        position: absolute;
        bottom: 2rem;
        left: 2rem;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 1rem;
        border-radius: 12px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
        font-size: 0.85rem;
        color: var(--gray);
        max-width: 280px;
        animation: slideInLeft 0.5s ease;
    }

    @keyframes slideInLeft {
        from {
            opacity: 0;
            transform: translateX(-20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .connection-indicator {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: var(--success);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }

    /* Scrollbar styling */
    .sidebar::-webkit-scrollbar,
    .modal-content::-webkit-scrollbar {
        width: 6px;
    }

    .sidebar::-webkit-scrollbar-track,
    .modal-content::-webkit-scrollbar-track {
        background: rgba(0,0,0,0.1);
        border-radius: 3px;
    }

    .sidebar::-webkit-scrollbar-thumb,
    .modal-content::-webkit-scrollbar-thumb {
        background: var(--primary);
        border-radius: 3px;
    }

    .sidebar::-webkit-scrollbar-thumb:hover,
    .modal-content::-webkit-scrollbar-thumb:hover {
        background: var(--primary-dark);
    }

    @media (max-width: 768px) {
        .header {
            padding: 1rem;
            flex-direction: column;
            gap: 1rem;
        }

        .logo {
            font-size: 1.2rem;
        }

        .toolbar {
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.6rem 1rem;
            font-size: 0.85rem;
        }

        .sidebar {
            width: 300px;
        }

        .modal-content {
            width: 95vw;
            padding: 1.5rem;
            border-radius: 16px;
        }

        .zoom-controls, .help-tooltip {
            display: none;
        }

        .main-container {
            height: calc(100vh - 140px);
        }
    }

    @media (max-width: 480px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }
        
        .toolbar {
            gap: 0.25rem;
        }
        
        .btn {
            padding: 0.5rem 0.75rem;
            font-size: 0.8rem;
        }
    }
</style>
</head>
<body>

<!-- Header -->
<div class="header">
    <div class="logo">
        Cartographie ISO27001
    </div>
    <div class="toolbar">
        <button class="btn btn-success" onclick="openAddServerModal()">
            üñ•Ô∏è Serveur
        </button>
        <button class="btn" onclick="openManageListsModal()">
            ‚öôÔ∏è Listes
        </button>
        <button class="btn btn-secondary" onclick="exportJSON()">
            üíæ JSON
        </button>
        <button class="btn" onclick="exportDrawio()">
            üì§ Draw.io
        </button>
        <button class="btn btn-success" onclick="generateAuditPDF()">
            üìã PDF Audit
        </button>
        <button class="btn btn-warning" onclick="importJSON()">
            üìÅ Importer
        </button>
        <button class="btn btn-danger" onclick="clearAll()">
            üóëÔ∏è Effacer
        </button>
        <button class="btn btn-secondary" onclick="showHelp()">
            ‚ùì Aide
        </button>
        <button class="btn btn-secondary" onclick="exportSVG()">
            üñºÔ∏è SVG
        </button>
    </div>
</div>

<!-- Main Container -->
<div class="main-container">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <button class="sidebar-toggle" onclick="toggleSidebar()">
            <span id="sidebarToggleIcon">‚óÄ</span>
        </button>

        <!-- Statistics -->
        <div class="stats-panel" id="statsPanel">
            <h3>üìä Statistiques</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-value" id="serverCount">0</span>
                    <span class="stat-label">Serveurs</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="accountCount">0</span>
                    <span class="stat-label">Comptes</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="identityCount">0</span>
                    <span class="stat-label">Identit√©s</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="connectionCount">0</span>
                    <span class="stat-label">Connexions</span>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls-section">
            <h3>üéõÔ∏è Contr√¥les rapides</h3>
            <div class="control-group">
                <button class="btn" onclick="centerView()" style="width: 100%; justify-content: center;">
                    üéØ Centrer la vue
                </button>
                <button class="btn btn-secondary" onclick="resetZoom()" style="width: 100%; justify-content: center;">
                    üîÑ R√©initialiser zoom
                </button>
            </div>
        </div>

        <!-- Quick Help -->
        <div class="controls-section">
            <h3>üí° Raccourcis</h3>
            <div style="font-size: 0.85rem; color: var(--gray); line-height: 1.4;">
                <p><strong>Ctrl + Molette :</strong> Zoom</p>
                <p><strong>Clic + Glisser :</strong> D√©placer</p>
                <p><strong>Clic sur n≈ìud :</strong> Ajouter enfant</p>
                <p><strong>Croix rouge :</strong> Supprimer</p>
            </div>
        </div>

        <!-- PDF Audit Section -->
        <div class="controls-section">
            <h3>üìã Audit & Conformit√©</h3>
            <div class="control-group">
                <button class="btn btn-success" onclick="generateAuditPDF()" style="width: 100%; justify-content: center;">
                    üìã G√©n√©rer PDF d'audit
                </button>
                <button class="btn btn-secondary" onclick="testPDFGeneration()" style="width: 100%; justify-content: center; font-size: 0.8rem; margin-top: 0.5rem;">
                    üß™ Test PDF
                </button>
                <div style="font-size: 0.8rem; color: var(--gray); margin-top: 0.5rem; text-align: center;">
                    Document officiel avec<br>section de signature
                </div>
            </div>
        </div>

        <div class="controls-section">
            <h3>‚ÑπÔ∏è √âtat du syst√®me</h3>
            <div style="font-size: 0.85rem; color: var(--gray); line-height: 1.4;">
                <p id="systemStatus">üîÑ V√©rification...</p>
                <p id="pdfLibStatus">üìö Librairies: <span id="libStatus">En cours...</span></p>
            </div>
        </div>
    </div>

    <!-- Canvas -->
    <div class="canvas-container">
        <div id="container">
            <svg id="svgCanvas">
                <defs>
                    <linearGradient id="serverGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#9b59b6;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#8e44ad;stop-opacity:1" />
                    </linearGradient>
                    <linearGradient id="accountGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#3498db;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#2980b9;stop-opacity:1" />
                    </linearGradient>
                    <linearGradient id="identityGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#2ecc71;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#27ae60;stop-opacity:1" />
                    </linearGradient>
                </defs>
            </svg>
        </div>

        <!-- Zoom Controls -->
        <div class="zoom-controls">
            <button class="zoom-btn" onclick="zoomIn()" title="Zoom avant">+</button>
            <button class="zoom-btn" onclick="zoomOut()" title="Zoom arri√®re">‚àí</button>
            <button class="zoom-btn" onclick="resetZoom()" title="Vue d'ensemble">‚åÇ</button>
        </div>

        <!-- Help Tooltip -->
        <div class="help-tooltip">
            <strong>üöÄ D√©marrage rapide</strong><br>
            1. Ajoutez un serveur<br>
            2. Cliquez dessus pour ajouter un compte<br>
            3. Cliquez sur le compte pour ajouter une identit√©
        </div>

        <!-- Connection Indicator -->
        <div class="connection-indicator" id="connectionIndicator">
            ‚úì Application pr√™te
        </div>
    </div>
</div>

<!-- Modal Serveur -->
<div class="modal" id="serverModal">
    <div class="modal-content">
        <h3>üñ•Ô∏è Ajouter un serveur</h3>
        <label>Nom du serveur :</label>
        <input type="text" id="serverName" placeholder="Ex: SRV-WEB-01">
        <label>Syst√®me d'exploitation :</label>
        <select id="serverOS"></select>
        <label>Logiciel principal :</label>
        <select id="serverSoftware"></select>
        <button onclick="confirmAddServer()">Ajouter le serveur</button>
        <button onclick="closeModal('serverModal')">Annuler</button>
    </div>
</div>

<!-- Modal Compte -->
<div class="modal" id="accountModal">
    <div class="modal-content">
        <h3>üë§ Ajouter un compte</h3>
        <label>Nom du compte :</label>
        <input type="text" id="accountName" placeholder="Ex: admin_db">
        <label>Privil√®ges :</label>
        <input type="text" id="accountRights" placeholder="Ex: Administrateur syst√®me">
        <label>Type d'acc√®s :</label>
        <select id="accountTypeAccess"></select>
        <label>M√©thode d'authentification :</label>
        <select id="accountAuthMethod"></select>
        <label>Type de compte :</label>
        <select id="accountType"></select>
        <button onclick="confirmAddAccount()">Ajouter le compte</button>
        <button onclick="closeModal('accountModal')">Annuler</button>
    </div>
</div>

<!-- Modal Identit√© -->
<div class="modal" id="identityModal">
    <div class="modal-content">
        <h3>üÜî Ajouter une identit√©</h3>
        <label>Nom de la personne :</label>
        <input type="text" id="identityName" placeholder="Ex: Jean Dupont">
        <label>R√¥le :</label>
        <select id="identityRole"></select>
        <label>Justification :</label>
        <select id="identityJustification"></select>
        <label>Date derni√®re revue :</label>
        <input type="date" id="identityLastReview">
        <label>Date prochaine revue :</label>
        <input type="date" id="identityNextReview">
        <button onclick="confirmAddIdentity()">Ajouter l'identit√©</button>
        <button onclick="closeModal('identityModal')">Annuler</button>
    </div>
</div>

<!-- Modal Listes -->
<div class="modal" id="listsModal">
    <div class="modal-content">
        <h3>‚öôÔ∏è G√©rer les listes</h3>
        <label>Syst√®mes d'exploitation (un par ligne) :</label>
        <textarea id="osListEdit" rows="4" placeholder="Windows Server 2022&#10;Ubuntu 22.04&#10;Debian 12"></textarea>
        <label>Logiciels (un par ligne) :</label>
        <textarea id="softwareListEdit" rows="4" placeholder="SQL Server&#10;Apache&#10;Nginx"></textarea>
        <label>Types d'acc√®s (un par ligne) :</label>
        <textarea id="typeAccessListEdit" rows="3" placeholder="Administration&#10;Lecture seule&#10;Application"></textarea>
        <label>M√©thodes d'authentification (un par ligne) :</label>
        <textarea id="authMethodListEdit" rows="4" placeholder="MFA&#10;Mot de passe&#10;Certificat&#10;SSO"></textarea>
        <label>Types de compte (un par ligne) :</label>
        <textarea id="typeAccountListEdit" rows="4" placeholder="Personnel&#10;Partag√©&#10;Service&#10;Application"></textarea>
        <label>R√¥les (un par ligne) :</label>
        <textarea id="roleListEdit" rows="4" placeholder="Admin syst√®me&#10;DBA&#10;Support&#10;DevOps"></textarea>
        <label>Justifications (un par ligne) :</label>
        <textarea id="justificationListEdit" rows="3" placeholder="Projet X&#10;Maintenance&#10;Urgence"></textarea>
        <button onclick="saveLists()">Enregistrer les modifications</button>
        <button onclick="closeModal('listsModal')">Fermer</button>
    </div>
</div>

<!-- Modal PDF Audit -->
<div class="modal" id="pdfAuditModal">
    <div class="modal-content" style="max-width: 600px;">
        <h3>üìã G√©n√©ration PDF d'Audit ISO27001</h3>
        
        <div class="form-group">
            <label>Titre du document :</label>
            <input type="text" id="pdfTitle" class="form-control" value="Cartographie des Comptes Privil√©gi√©s" placeholder="Titre du rapport d'audit">
        </div>
        
        <div class="form-group">
            <label>P√©riode d'audit :</label>
            <div style="display: flex; gap: 1rem;">
                <input type="date" id="auditDateFrom" class="form-control" style="flex: 1;">
                <input type="date" id="auditDateTo" class="form-control" style="flex: 1;">
            </div>
        </div>
        
        <div class="form-group">
            <label>Auditeur responsable :</label>
            <input type="text" id="auditorName" class="form-control" placeholder="Nom de l'auditeur">
        </div>
        
        <div class="form-group">
            <label>Organisation :</label>
            <input type="text" id="organizationName" class="form-control" placeholder="Nom de l'organisation">
        </div>
        
        <div class="form-group">
            <label>Commentaires audit :</label>
            <textarea id="auditComments" class="form-control" rows="3" placeholder="Observations, recommandations, points d'attention..."></textarea>
        </div>
        
        <div class="form-group">
            <label>Classification :</label>
            <select id="documentClassification" class="form-control">
                <option value="CONFIDENTIEL">üîí CONFIDENTIEL</option>
                <option value="RESTREINT">‚ö†Ô∏è RESTREINT</option>
                <option value="INTERNE">üè¢ USAGE INTERNE</option>
                <option value="PUBLIC">üåê PUBLIC</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>
                <input type="checkbox" id="includeSignatureSection" checked>
                Inclure section de signature pour validation
            </label>
        </div>
        
        <div class="form-group">
            <label>
                <input type="checkbox" id="includeStatistics" checked>
                Inclure statistiques d√©taill√©es
            </label>
        </div>
        
        <div class="form-group">
            <label>
                <input type="checkbox" id="includeMetadata" checked>
                Inclure m√©tadonn√©es techniques
            </label>
        </div>
        
        <div style="display: flex; gap: 1rem; margin-top: 2rem; justify-content: flex-end;">
            <button class="btn btn-secondary" onclick="closeModal('pdfAuditModal')">Annuler</button>
            <button class="btn btn-success" onclick="confirmGenerateAuditPDF()">üìã G√©n√©rer le PDF</button>
        </div>
    </div>
</div>

<input type="file" id="fileInput" style="display:none" accept=".json">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
// Donn√©es existantes (gard√©es telles quelles)
let data = { 
    servers: [], 
    settings: {
        osList: ["Windows Server 2022", "Ubuntu 22.04", "Debian 12"],
        softwareList: ["SQL Server", "Apache", "Nginx"],
        typeAccessList: ["Administration", "Lecture seule", "Application"],
        authMethodList: ["MFA", "Mot de passe", "Certificat", "SSO"],
        typeAccountList: ["Personnel", "Partag√©", "Service", "Application"],
        roleList: ["Admin syst√®me", "DBA", "Support", "DevOps"],
        justificationList: ["Projet X", "Maintenance", "Urgence"]
    }
};
const svg = document.getElementById('svgCanvas');

// Variables pour les nouvelles fonctionnalit√©s
let sidebarCollapsed = false;

// ==== Fonctions modales et ajout (JavaScript original conserv√©) ====
function openAddServerModal() {
    document.getElementById('serverName').value = "";
    populateSelect('serverOS', data.settings.osList, true);
    populateSelect('serverSoftware', data.settings.softwareList, true);
    document.getElementById('serverModal').style.display = 'flex';
    updateConnectionIndicator('Ajout d\'un serveur...');
}

function confirmAddServer() {
    const server = {
        id: Date.now(),
        name: document.getElementById('serverName').value.trim(),
        os: document.getElementById('serverOS').value || "",
        software: document.getElementById('serverSoftware').value || "",
        accounts: []
    };
    if (!server.name) return alert("Nom requis");
    data.servers.push(server);
    closeModal('serverModal');
    render();
    updateStats();
    updateConnectionIndicator(`Serveur "${server.name}" ajout√©`);
    setTimeout(() => updateConnectionIndicator('‚úì Pr√™t'), 2000);
}

let currentServerId = null;
function openAddAccountModal(serverId) {
    currentServerId = serverId;
    document.getElementById('accountName').value = "";
    document.getElementById('accountRights').value = "";
    populateSelect('accountTypeAccess', data.settings.typeAccessList, true);
    populateSelect('accountAuthMethod', data.settings.authMethodList, true);
    populateSelect('accountType', data.settings.typeAccountList, true);
    document.getElementById('accountModal').style.display = 'flex';
    updateConnectionIndicator('Ajout d\'un compte...');
}

function confirmAddAccount() {
    const server = data.servers.find(s => s.id === currentServerId);
    const account = {
        id: Date.now(),
        name: document.getElementById('accountName').value.trim(),
        rights: document.getElementById('accountRights').value.trim(),
        typeAccess: document.getElementById('accountTypeAccess').value || "",
        authMethod: document.getElementById('accountAuthMethod').value || "",
        typeAccount: document.getElementById('accountType').value || "",
        identities: []
    };
    if (!account.name) return alert("Nom requis");
    server.accounts.push(account);
    closeModal('accountModal');
    render();
    updateStats();
    updateConnectionIndicator(`Compte "${account.name}" ajout√©`);
    setTimeout(() => updateConnectionIndicator('‚úì Pr√™t'), 2000);
}

let currentAccountId = null;
function openAddIdentityModal(serverId, accountId) {
    currentServerId = serverId;
    currentAccountId = accountId;
    document.getElementById('identityName').value = "";
    populateSelect('identityRole', data.settings.roleList, true);
    populateSelect('identityJustification', data.settings.justificationList, true);
    document.getElementById('identityLastReview').value = "";
    document.getElementById('identityNextReview').value = "";
    document.getElementById('identityModal').style.display = 'flex';
    updateConnectionIndicator('Ajout d\'une identit√©...');
}

function confirmAddIdentity() {
    const server = data.servers.find(s => s.id === currentServerId);
    const account = server.accounts.find(a => a.id === currentAccountId);
    const identity = {
        id: Date.now(),
        name: document.getElementById('identityName').value.trim(),
        role: document.getElementById('identityRole').value || "",
        justification: document.getElementById('identityJustification').value || "",
        lastReview: document.getElementById('identityLastReview').value || "",
        nextReview: document.getElementById('identityNextReview').value || ""
    };
    if (!identity.name) return alert("Nom requis");
    account.identities.push(identity);
    closeModal('identityModal');
    render();
    updateStats();
    updateConnectionIndicator(`Identit√© "${identity.name}" ajout√©e`);
    setTimeout(() => updateConnectionIndicator('‚úì Pr√™t'), 2000);
}

// ==== Listes ====
function openManageListsModal() {
    document.getElementById('osListEdit').value = data.settings.osList.join("\n");
    document.getElementById('softwareListEdit').value = data.settings.softwareList.join("\n");
    document.getElementById('typeAccessListEdit').value = data.settings.typeAccessList.join("\n");
    document.getElementById('authMethodListEdit').value = data.settings.authMethodList.join("\n");
    document.getElementById('typeAccountListEdit').value = data.settings.typeAccountList.join("\n");
    document.getElementById('roleListEdit').value = data.settings.roleList.join("\n");
    document.getElementById('justificationListEdit').value = data.settings.justificationList.join("\n");
    document.getElementById('listsModal').style.display = 'flex';
}

function saveLists() {
    data.settings.osList = splitList('osListEdit');
    data.settings.softwareList = splitList('softwareListEdit');
    data.settings.typeAccessList = splitList('typeAccessListEdit');
    data.settings.authMethodList = splitList('authMethodListEdit');
    data.settings.typeAccountList = splitList('typeAccountListEdit');
    data.settings.roleList = splitList('roleListEdit');
    data.settings.justificationList = splitList('justificationListEdit');
    closeModal('listsModal');
    updateConnectionIndicator('Listes mises √† jour');
    setTimeout(() => updateConnectionIndicator('‚úì Pr√™t'), 2000);
}

function splitList(id) {
    return document.getElementById(id).value.split("\n").map(s => s.trim()).filter(s => s);
}

// ==== Suppression ====
function deleteNode(type, serverId, accountId, identityId) {
    if (!confirm("Supprimer cet √©l√©ment ?")) return;
    if (type === 'server') {
        data.servers = data.servers.filter(s => s.id !== serverId);
    } else if (type === 'account') {
        const server = data.servers.find(s => s.id === serverId);
        server.accounts = server.accounts.filter(a => a.id !== accountId);
    } else if (type === 'identity') {
        const server = data.servers.find(s => s.id === serverId);
        const account = server.accounts.find(a => a.id === accountId);
        account.identities = account.identities.filter(i => i.id !== identityId);
    }
    render();
    updateStats();
    updateConnectionIndicator('√âl√©ment supprim√©');
    setTimeout(() => updateConnectionIndicator('‚úì Pr√™t'), 1500);
}

// ==== UI ====
function closeModal(id) { 
    document.getElementById(id).style.display = 'none'; 
}

function populateSelect(id, items, addEmpty) {
    const sel = document.getElementById(id);
    sel.innerHTML = "";
    if (addEmpty) sel.innerHTML += '<option value="">-- Aucun --</option>';
    items.forEach(item => sel.innerHTML += `<option value="${item}">${item}</option>`);
}

// ==== Rendu (JavaScript original conserv√©) ====
function render() {
    svg.innerHTML = `
        <defs>
            <linearGradient id="serverGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#9b59b6;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#8e44ad;stop-opacity:1" />
            </linearGradient>
            <linearGradient id="accountGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#3498db;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#2980b9;stop-opacity:1" />
            </linearGradient>
            <linearGradient id="identityGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#2ecc71;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#27ae60;stop-opacity:1" />
            </linearGradient>
        </defs>
    `;
    
    const hGap = 180, vGap = 130;
    const calcWidth = node => {
        if (node.identities) return Math.max(1, node.identities.length) * hGap;
        if (node.accounts) return node.accounts.reduce((sum,a) => sum + calcWidth(a), 0) || hGap;
        return hGap;
    };
    let xCursor = 0;
    data.servers.forEach(server => {
        const branchW = calcWidth(server);
        const sX = xCursor + branchW/2, sY = 50;
        let label = server.name;
        if (server.os) label += `\n${server.os}`;
        if (server.software) label += `\n${server.software}`;
        drawNode(sX, sY, label, 'server', () => openAddAccountModal(server.id), () => deleteNode('server', server.id));
        let accX = xCursor;
        server.accounts.forEach(account => {
            const accW = calcWidth(account);
            const aX = accX + accW/2, aY = sY + vGap;
            drawLine(sX, sY+20, aX, aY-20, '#8e44ad');
            let accLabel = `${account.name}`;
            if (account.rights) accLabel += `\n${account.rights}`;
            if (account.typeAccess) accLabel += `\n${account.typeAccess}`;
            if (account.authMethod) accLabel += `\n${account.authMethod}`;
            if (account.typeAccount) accLabel += `\n${account.typeAccount}`;
            drawNode(aX, aY, accLabel, 'account', () => openAddIdentityModal(server.id, account.id), () => deleteNode('account', server.id, account.id));
            let idX = accX;
            account.identities.forEach(identity => {
                const iX = idX + hGap/2, iY = aY + vGap;
                drawLine(aX, aY+20, iX, iY-20, '#27ae60');
                let idLabel = `${identity.name}`;
                if (identity.role) idLabel += `\n${identity.role}`;
                if (identity.justification) idLabel += `\n${identity.justification}`;
                if (identity.lastReview) idLabel += `\nDerni√®re: ${identity.lastReview}`;
                if (identity.nextReview) idLabel += `\nProchaine: ${identity.nextReview}`;
                drawNode(iX, iY, idLabel, 'identity', null, () => deleteNode('identity', server.id, account.id, identity.id));
                idX += hGap;
            });
            accX += accW;
        });
        xCursor += branchW + hGap;
    });
}

function drawNode(x, y, text, type, onClick, onDelete) {
    const lines = text.split("\n");
    const maxLineLength = Math.max(...lines.map(l => l.length));
    const width = Math.min(240, Math.max(120, maxLineLength * 7));
    const height = 20 + lines.length * 15;
    const g = document.createElementNS("http://www.w3.org/2000/svg","g");
    g.style.cursor = onClick ? 'pointer' : 'default';
    
    const rect = document.createElementNS("http://www.w3.org/2000/svg","rect");
    rect.setAttribute("x", x - width/2); 
    rect.setAttribute("y", y - height/2);
    rect.setAttribute("width", width); 
    rect.setAttribute("height", height);
    rect.setAttribute("rx", 12);
    rect.setAttribute("class", type);
    if (onClick) rect.addEventListener('click', onClick);
    g.appendChild(rect);
    
    lines.forEach((line, i) => {
        const label = document.createElementNS("http://www.w3.org/2000/svg","text");
        label.setAttribute("x", x);
        label.setAttribute("y", y - (lines.length-1)*7 + i*15);
        label.setAttribute("text-anchor", "middle");
        label.setAttribute("class", "label");
        label.textContent = line;
        g.appendChild(label);
    });
    
    if (onDelete) {
        const del = document.createElementNS("http://www.w3.org/2000/svg","text");
        del.setAttribute("x", x + width/2 - 12);
        del.setAttribute("y", y - height/2 + 15);
        del.setAttribute("fill", "#ff4757");
        del.setAttribute("font-size", "18");
        del.setAttribute("font-weight", "bold");
        del.setAttribute("cursor", "pointer");
        del.textContent = "√ó";
        del.addEventListener('click', e => { e.stopPropagation(); onDelete(); });
        del.addEventListener('mouseenter', () => del.setAttribute('fill', '#ff3838'));
        del.addEventListener('mouseleave', () => del.setAttribute('fill', '#ff4757'));
        g.appendChild(del);
    }
    svg.appendChild(g);
}

function drawLine(x1,y1,x2,y2,color) {
    const path = document.createElementNS("http://www.w3.org/2000/svg","path");
    const midY = (y1+y2)/2;
    path.setAttribute("d", `M${x1},${y1} C${x1},${midY} ${x2},${midY} ${x2},${y2}`);
    path.setAttribute("stroke", color);
    path.setAttribute("fill", "none");
    path.setAttribute("stroke-width", "2");
    path.setAttribute("opacity", "0.7");
    svg.appendChild(path);
}

// ==== JSON (JavaScript original conserv√©) ====
function exportJSON() {
    const blob = new Blob([JSON.stringify(data,null,2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; 
    a.download = `cartographie-iso27001-${new Date().toISOString().split('T')[0]}.json`; 
    a.click();
    URL.revokeObjectURL(url);
    updateConnectionIndicator('Export JSON r√©ussi');
    setTimeout(() => updateConnectionIndicator('‚úì Pr√™t'), 2000);
}

function importJSON() { 
    document.getElementById('fileInput').click(); 
}

document.getElementById('fileInput').addEventListener('change', e => {
    const file = e.target.files[0]; 
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => { 
        try {
            data = JSON.parse(ev.target.result); 
            render(); 
            updateStats();
            updateConnectionIndicator('Import r√©ussi');
            setTimeout(() => updateConnectionIndicator('‚úì Pr√™t'), 2000);
        } catch (error) {
            alert('Erreur lors de l\'import: ' + error.message);
            updateConnectionIndicator('Erreur d\'import');
            setTimeout(() => updateConnectionIndicator('‚úì Pr√™t'), 2000);
        }
    };
    reader.readAsText(file);
});

function exportDrawio() {
    const escapeXml = (unsafe) => {
        if (!unsafe) return '';
        return unsafe
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&apos;');
    };

    // Layout settings
    const serverSpacingX = 300;   // Space between servers
    const accountSpacingY = 180;  // Vertical space between levels
    const accountSpacingX = 220;  // Horizontal space between accounts
    const identitySpacingX = 200; // Horizontal space between identities

    let xml = '<?xml version="1.0" encoding="UTF-8"?><mxfile><diagram name="Privilege Map"><mxGraphModel><root>';
    xml += '<mxCell id="0"/><mxCell id="1" parent="0"/>';
    let cellId = 2;

    data.servers.forEach((s, si) => {
        const serverX = si * serverSpacingX;
        const sid = cellId++;
        xml += `<mxCell id="${sid}" value="${escapeXml(s.name)}${s.os ? '&#xa;' + escapeXml(s.os) : ''}${s.software ? '&#xa;' + escapeXml(s.software) : ''}" style="shape=ellipse;fillColor=#8e44ad;fontColor=#FFFFFF;" vertex="1" parent="1"><mxGeometry x="${serverX}" y="0" width="160" height="60" as="geometry"/></mxCell>`;

        s.accounts.forEach((a, ai) => {
            const accountX = serverX + ai * accountSpacingX;
            const accountY = accountSpacingY;
            const aid = cellId++;
            xml += `<mxCell id="${aid}" value="${escapeXml(a.name)}${a.rights ? '&#xa;' + escapeXml(a.rights) : ''}${a.typeAccess ? '&#xa;' + escapeXml(a.typeAccess) : ''}${a.authMethod ? '&#xa;' + escapeXml(a.authMethod) : ''}${a.typeAccount ? '&#xa;' + escapeXml(a.typeAccount) : ''}" style="shape=ellipse;fillColor=#2980b9;fontColor=#FFFFFF;" vertex="1" parent="1"><mxGeometry x="${accountX}" y="${accountY}" width="160" height="60" as="geometry"/></mxCell>`;
            xml += `<mxCell id="${cellId++}" edge="1" parent="1" source="${sid}" target="${aid}"><mxGeometry relative="1" as="geometry"/></mxCell>`;

            a.identities.forEach((i, ii) => {
                const identityX = accountX + ii * identitySpacingX;
                const identityY = accountSpacingY * 2;
                const iid = cellId++;
                xml += `<mxCell id="${iid}" value="${escapeXml(i.name)}${i.role ? '&#xa;' + escapeXml(i.role) : ''}${i.justification ? '&#xa;' + escapeXml(i.justification) : ''}${i.lastReview ? '&#xa;' + escapeXml(i.lastReview) : ''}${i.nextReview ? '&#xa;' + escapeXml(i.nextReview) : ''}" style="shape=ellipse;fillColor=#27ae60;fontColor=#FFFFFF;" vertex="1" parent="1"><mxGeometry x="${identityX}" y="${identityY}" width="160" height="60" as="geometry"/></mxCell>`;
                xml += `<mxCell id="${cellId++}" edge="1" parent="1" source="${aid}" target="${iid}"><mxGeometry relative="1" as="geometry"/></mxCell>`;
            });
        });
    });

    xml += '</root></mxGraphModel></diagram></mxfile>';

    const blob = new Blob([xml], { type: 'application/xml' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `cartographie-iso27001-${new Date().toISOString().split('T')[0]}.drawio`;
    a.click();
    URL.revokeObjectURL(url);

    updateConnectionIndicator('Export Draw.io r√©ussi');
    setTimeout(() => updateConnectionIndicator('‚úì Pr√™t'), 2000);
}




// geneerate svg
function exportSVG() {
    try {
        const svgElement = document.getElementById('svgCanvas').cloneNode(true);

        // Get CSS from the page
        let css = '';
        document.querySelectorAll('style').forEach(styleEl => {
            css += styleEl.textContent;
        });

        // Create <style> element inside SVG with all CSS
        const styleElement = document.createElementNS('http://www.w3.org/2000/svg', 'style');
        styleElement.setAttribute('type', 'text/css');
        styleElement.textContent = css;
        svgElement.insertBefore(styleElement, svgElement.firstChild);

        // Ensure namespaces
        svgElement.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
        svgElement.setAttribute('xmlns:xlink', 'http://www.w3.org/1999/xlink');

        // Serialize
        const serializer = new XMLSerializer();
        let source = serializer.serializeToString(svgElement);
        source = `<?xml version="1.0" encoding="UTF-8"?>\n` + source;

        // Download
        const blob = new Blob([source], { type: 'image/svg+xml;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `cartographie-iso27001-${new Date().toISOString().split('T')[0]}.svg`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        updateConnectionIndicator('Export SVG r√©ussi');
        setTimeout(() => updateConnectionIndicator('‚úì Pr√™t'), 2000);

    } catch (error) {
        console.error('Erreur export SVG:', error);
        updateConnectionIndicator('‚ùå Erreur export SVG');
        setTimeout(() => updateConnectionIndicator('‚úì Pr√™t'), 2000);
        alert('Erreur lors de la g√©n√©ration du SVG: ' + error.message);
    }
}



// ==== G√âN√âRATION PDF AUDIT ====
function generateAuditPDF() {
    // D√©finir les dates par d√©faut
    const today = new Date();
    const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
    
    document.getElementById('auditDateFrom').value = lastMonth.toISOString().split('T')[0];
    document.getElementById('auditDateTo').value = today.toISOString().split('T')[0];
    document.getElementById('auditorName').value = '';
    document.getElementById('organizationName').value = '';
    document.getElementById('auditComments').value = '';
    
    document.getElementById('pdfAuditModal').style.display = 'flex';
    updateConnectionIndicator('Pr√©paration PDF d\'audit...');
}

async function confirmGenerateAuditPDF() {
    const { jsPDF } = window.jspdf;
    
    // V√©rifier que les librairies sont disponibles
    if (!window.jspdf) {
        alert('Erreur: La librairie PDF n\'est pas charg√©e. Veuillez recharger la page.');
        return;
    }
    
    try {
        updateConnectionIndicator('G√©n√©ration du PDF en cours...');
        closeModal('pdfAuditModal');
        
        // Petite pause pour laisser l'interface se mettre √† jour
        await new Promise(resolve => setTimeout(resolve, 100));
        
        // R√©cup√©rer les donn√©es du formulaire
        const pdfData = {
            title: document.getElementById('pdfTitle').value || 'Cartographie des Comptes Privil√©gi√©s',
            dateFrom: document.getElementById('auditDateFrom').value,
            dateTo: document.getElementById('auditDateTo').value,
            auditor: document.getElementById('auditorName').value || 'Non sp√©cifi√©',
            organization: document.getElementById('organizationName').value || 'Organisation',
            comments: document.getElementById('auditComments').value || '',
            classification: document.getElementById('documentClassification').value,
            includeSignature: document.getElementById('includeSignatureSection').checked,
            includeStats: document.getElementById('includeStatistics').checked,
            includeMeta: document.getElementById('includeMetadata').checked
        };
        
        updateConnectionIndicator('Cr√©ation du document PDF...');
        
        // Cr√©er le PDF
        const pdf = new jsPDF('l', 'mm', 'a4'); // Format paysage
        let yPosition = 20;
        
        // === EN-T√äTE DU DOCUMENT ===
        pdf.setFontSize(20);
        pdf.setFont(undefined, 'bold');
        pdf.text(pdfData.title, 20, yPosition);
        yPosition += 10;
        
        pdf.setFontSize(12);
        pdf.setFont(undefined, 'normal');
        pdf.text(`Audit ISO27001 - ${pdfData.classification}`, 20, yPosition);
        yPosition += 15;
        
        // Ligne de s√©paration
        pdf.setDrawColor(102, 126, 234);
        pdf.setLineWidth(0.5);
        pdf.line(20, yPosition, 277, yPosition);
        yPosition += 10;
        
        // === INFORMATIONS G√âN√âRALES ===
        pdf.setFontSize(14);
        pdf.setFont(undefined, 'bold');
        pdf.text('INFORMATIONS G√âN√âRALES', 20, yPosition);
        yPosition += 8;
        
        pdf.setFontSize(10);
        pdf.setFont(undefined, 'normal');
        pdf.text(`Organisation: ${pdfData.organization}`, 20, yPosition);
        yPosition += 5;
        pdf.text(`Auditeur responsable: ${pdfData.auditor}`, 20, yPosition);
        yPosition += 5;
        pdf.text(`P√©riode d'audit: ${formatDate(pdfData.dateFrom)} au ${formatDate(pdfData.dateTo)}`, 20, yPosition);
        yPosition += 5;
        pdf.text(`Date de g√©n√©ration: ${formatDate(new Date().toISOString().split('T')[0])}`, 20, yPosition);
        yPosition += 10;
        
        // === STATISTIQUES ===
        if (pdfData.includeStats) {
            const stats = calculateDetailedStats();
            
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.text('STATISTIQUES D√âTAILL√âES', 20, yPosition);
            yPosition += 8;
            
            pdf.setFontSize(10);
            pdf.setFont(undefined, 'normal');
            
            pdf.text(`Nombre total de serveurs: ${stats.serverCount}`, 20, yPosition);
            yPosition += 5;
            pdf.text(`Nombre total de comptes: ${stats.accountCount}`, 20, yPosition);
            yPosition += 5;
            pdf.text(`Nombre total d'identit√©s: ${stats.identityCount}`, 20, yPosition);
            yPosition += 5;
            pdf.text(`Taux de couverture identit√©s: ${stats.identityCoverage}%`, 20, yPosition);
            yPosition += 8;
            
            // R√©partition par OS
            pdf.setFont(undefined, 'bold');
            pdf.text('R√©partition par OS:', 20, yPosition);
            yPosition += 5;
            pdf.setFont(undefined, 'normal');
            Object.entries(stats.osSummary).forEach(([os, count]) => {
                pdf.text(`  ‚Ä¢ ${os}: ${count} serveur(s)`, 25, yPosition);
                yPosition += 4;
            });
            yPosition += 5;
            
            // Comptes par type
            pdf.setFont(undefined, 'bold');
            pdf.text('R√©partition des comptes:', 20, yPosition);
            yPosition += 5;
            pdf.setFont(undefined, 'normal');
            Object.entries(stats.accountTypes).forEach(([type, count]) => {
                pdf.text(`  ‚Ä¢ ${type || 'Non sp√©cifi√©'}: ${count} compte(s)`, 25, yPosition);
                yPosition += 4;
            });
            yPosition += 10;
        }
        
        // === CAPTURE D'√âCRAN DE LA CARTOGRAPHIE ===
        pdf.setFontSize(14);
        pdf.setFont(undefined, 'bold');
        pdf.text('CARTOGRAPHIE VISUELLE', 20, yPosition);
        yPosition += 10;
        
        // G√©n√©rer la capture d'√©cran du SVG avec m√©thode alternative
        let imgData = null;
        let imgWidth = 240;
        let imgHeight = 100;
        
        try {
            // M√©thode 1: Capturer le container complet
            const container = document.getElementById('container');
            const canvas = await html2canvas(container, {
                backgroundColor: '#ffffff',
                scale: 0.8,
                logging: false,
                useCORS: true,
                allowTaint: true,
                foreignObjectRendering: false,
                imageTimeout: 5000,
                removeContainer: false
            });
            
            imgData = canvas.toDataURL('image/png');
            imgHeight = (canvas.height * imgWidth) / canvas.width;
            
        } catch (error) {
            console.warn('M√©thode 1 √©chou√©e, tentative m√©thode 2:', error);
            
            try {
                // M√©thode 2: Convertir SVG en canvas manuellement
                const svgElement = document.getElementById('svgCanvas');
                const svgData = new XMLSerializer().serializeToString(svgElement);
                const svgBlob = new Blob([svgData], {type: 'image/svg+xml;charset=utf-8'});
                const svgUrl = URL.createObjectURL(svgBlob);
                
                const img = new Image();
                await new Promise((resolve, reject) => {
                    img.onload = resolve;
                    img.onerror = reject;
                    img.src = svgUrl;
                });
                
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = 800;
                tempCanvas.height = 600;
                const ctx = tempCanvas.getContext('2d');
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                ctx.drawImage(img, 0, 0, tempCanvas.width, tempCanvas.height);
                
                imgData = tempCanvas.toDataURL('image/png');
                imgHeight = (tempCanvas.height * imgWidth) / tempCanvas.width;
                
                URL.revokeObjectURL(svgUrl);
                
            } catch (error2) {
                console.warn('M√©thode 2 √©chou√©e, g√©n√©ration placeholder:', error2);
                
                // M√©thode 3: G√©n√©rer un placeholder avec les donn√©es
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = 800;
                tempCanvas.height = 400;
                const ctx = tempCanvas.getContext('2d');
                
                // Fond blanc
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                
                // Bordure
                ctx.strokeStyle = '#667eea';
                ctx.lineWidth = 2;
                ctx.strokeRect(10, 10, tempCanvas.width - 20, tempCanvas.height - 20);
                
                // Titre
                ctx.fillStyle = '#2d3748';
                ctx.font = 'bold 24px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Cartographie des Comptes Privil√©gi√©s', tempCanvas.width / 2, 50);
                
                // Statistiques visuelles
                ctx.font = '16px Arial';
                const stats = calculateDetailedStats();
                let yPos = 100;
                
                ctx.fillText(` ${stats.serverCount} Serveurs`, tempCanvas.width / 2, yPos);
                yPos += 30;
                ctx.fillText(` ${stats.accountCount} Comptes`, tempCanvas.width / 2, yPos);
                yPos += 30;
                ctx.fillText(` ${stats.identityCount} Identit√©s`, tempCanvas.width / 2, yPos);
                yPos += 50;
                
                // Message d'information
                ctx.font = '14px Arial';
                ctx.fillStyle = '#718096';
                ctx.fillText('Repr√©sentation simplifi√©e - Cartographie d√©taill√©e dans l\'inventaire ci-dessous', tempCanvas.width / 2, yPos);
                
                // Dessiner des √©l√©ments repr√©sentatifs
                if (data.servers.length > 0) {
                    ctx.fillStyle = '#8e44ad';
                    let xPos = 100;
                    data.servers.slice(0, 5).forEach((server, index) => {
                        ctx.fillRect(xPos, 250, 80, 40);
                        ctx.fillStyle = '#ffffff';
                        ctx.font = 'bold 12px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(server.name.substring(0, 10), xPos + 40, 275);
                        ctx.fillStyle = '#8e44ad';
                        xPos += 120;
                    });
                }
                
                imgData = tempCanvas.toDataURL('image/png');
                imgHeight = (tempCanvas.height * imgWidth) / tempCanvas.width;
            }
        }
        
        // V√©rifier si on a assez de place sur la page
        if (yPosition + imgHeight > 180) {
            pdf.addPage();
            yPosition = 20;
        }
        
        if (imgData) {
            pdf.addImage(imgData, 'PNG', 20, yPosition, imgWidth, imgHeight);
            yPosition += imgHeight + 10;
        } else {
            pdf.setFontSize(10);
            pdf.setFont(undefined, 'italic');
            pdf.text('Impossible de g√©n√©rer l\'image de la cartographie - Voir d√©tails ci-dessous', 20, yPosition);
            yPosition += 10;
        }
        
        // === D√âTAIL DES √âL√âMENTS ===
        pdf.addPage();
        yPosition = 20;
        
        pdf.setFontSize(14);
        pdf.setFont(undefined, 'bold');
        pdf.text('INVENTAIRE D√âTAILL√â', 20, yPosition);
        yPosition += 10;
        
        data.servers.forEach((server, serverIndex) => {
            // V√©rifier si on a assez de place
            if (yPosition > 180) {
                pdf.addPage();
                yPosition = 20;
            }
            
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'bold');
            pdf.text(`${serverIndex + 1}. SERVEUR: ${server.name}`, 20, yPosition);
            yPosition += 6;
            
            pdf.setFontSize(10);
            pdf.setFont(undefined, 'normal');
            if (server.os) {
                pdf.text(`   OS: ${server.os}`, 25, yPosition);
                yPosition += 4;
            }
            if (server.software) {
                pdf.text(`   Logiciel: ${server.software}`, 25, yPosition);
                yPosition += 4;
            }
            yPosition += 3;
            
            server.accounts.forEach((account, accountIndex) => {
                pdf.setFont(undefined, 'bold');
                pdf.text(`   ${serverIndex + 1}.${accountIndex + 1} Compte: ${account.name}`, 25, yPosition);
                yPosition += 5;
                
                pdf.setFont(undefined, 'normal');
                if (account.rights) pdf.text(`       Privil√®ges: ${account.rights}`, 30, yPosition), yPosition += 4;
                if (account.typeAccess) pdf.text(`       Type d'acc√®s: ${account.typeAccess}`, 30, yPosition), yPosition += 4;
                if (account.authMethod) pdf.text(`       Authentification: ${account.authMethod}`, 30, yPosition), yPosition += 4;
                if (account.typeAccount) pdf.text(`       Type compte: ${account.typeAccount}`, 30, yPosition), yPosition += 4;
                
                account.identities.forEach((identity, identityIndex) => {
                    if (yPosition > 180) {
                        pdf.addPage();
                        yPosition = 20;
                    }
                    
                    pdf.setFont(undefined, 'italic');
                    pdf.text(`        Identite: ${identity.name}`, 35, yPosition);
                    yPosition += 4;
                    
                    pdf.setFont(undefined, 'normal');
                    if (identity.role) pdf.text(`          R√¥le: ${identity.role}`, 40, yPosition), yPosition += 4;
                    if (identity.justification) pdf.text(`          Justification: ${identity.justification}`, 40, yPosition), yPosition += 4;
                    if (identity.lastReview) pdf.text(`          Derni√®re revue: ${formatDate(identity.lastReview)}`, 40, yPosition), yPosition += 4;
                    if (identity.nextReview) pdf.text(`          Prochaine revue: ${formatDate(identity.nextReview)}`, 40, yPosition), yPosition += 4;
                });
                yPosition += 3;
            });
            yPosition += 5;
        });
        
        // === COMMENTAIRES D'AUDIT ===
        if (pdfData.comments) {
            if (yPosition > 150) {
                pdf.addPage();
                yPosition = 20;
            }
            
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.text('OBSERVATIONS ET RECOMMANDATIONS', 20, yPosition);
            yPosition += 8;
            
            pdf.setFontSize(10);
            pdf.setFont(undefined, 'normal');
            const commentLines = pdf.splitTextToSize(pdfData.comments, 250);
            commentLines.forEach(line => {
                if (yPosition > 180) {
                    pdf.addPage();
                    yPosition = 20;
                }
                pdf.text(line, 20, yPosition);
                yPosition += 5;
            });
            yPosition += 10;
        }
        
        // === SECTION SIGNATURE ===
        if (pdfData.includeSignature) {
            if (yPosition > 120) {
                pdf.addPage();
                yPosition = 20;
            }
            
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.text('VALIDATION ET SIGNATURES', 20, yPosition);
            yPosition += 15;
            
            pdf.setFontSize(10);
            pdf.setFont(undefined, 'normal');
            
            // Tableau de signatures
            const signatureBoxes = [
                { title: 'AUDITEUR', role: 'Responsable de l\'audit' },
                { title: 'RESPONSABLE SI', role: 'Responsable S√©curit√© des SI' },
                { title: 'DIRECTION', role: 'Validation direction' }
            ];
            
            signatureBoxes.forEach((box, index) => {
                const xPos = 20 + (index * 85);
                
                // Cadre de signature
                pdf.setDrawColor(0, 0, 0);
                pdf.setLineWidth(0.3);
                pdf.rect(xPos, yPosition, 80, 40);
                
                pdf.setFont(undefined, 'bold');
                pdf.text(box.title, xPos + 2, yPosition + 5);
                pdf.setFont(undefined, 'normal');
                pdf.text(box.role, xPos + 2, yPosition + 10);
                
                pdf.text('Nom:', xPos + 2, yPosition + 20);
                pdf.text('Date:', xPos + 2, yPosition + 25);
                pdf.text('Signature:', xPos + 2, yPosition + 35);
            });
            yPosition += 50;
        }
        
        // === M√âTADONN√âES TECHNIQUES ===
        if (pdfData.includeMeta) {
            if (yPosition > 160) {
                pdf.addPage();
                yPosition = 20;
            }
            
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'bold');
            pdf.text('M√âTADONN√âES TECHNIQUES', 20, yPosition);
            yPosition += 8;
            
            pdf.setFontSize(8);
            pdf.setFont(undefined, 'normal');
            pdf.text(`G√©n√©r√© par: Cartographie ISO27001 v2.0`, 20, yPosition);
            yPosition += 4;
            pdf.text(`Hash du document: ${generateDocumentHash()}`, 20, yPosition);
            yPosition += 4;
            pdf.text(`Nombre total d'√©l√©ments trait√©s: ${data.servers.length + calculateDetailedStats().accountCount + calculateDetailedStats().identityCount}`, 20, yPosition);
        }
        
        // === PIED DE PAGE SUR TOUTES LES PAGES ===
        const pageCount = pdf.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
            pdf.setPage(i);
            pdf.setFontSize(8);
            pdf.setFont(undefined, 'normal');
            pdf.text(`${pdfData.classification} - Page ${i}/${pageCount}`, 20, 200);
            pdf.text(`G√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')} √† ${new Date().toLocaleTimeString('fr-FR')}`, 200, 200);
        }
        
        // Sauvegarder le PDF
        const fileName = `audit-iso27001-${pdfData.organization.replace(/[^a-zA-Z0-9]/g, '-')}-${new Date().toISOString().split('T')[0]}.pdf`;
        pdf.save(fileName);
        
        updateConnectionIndicator('PDF d\'audit g√©n√©r√© avec succ√®s ‚úì');
        setTimeout(() => updateConnectionIndicator('‚úì Pr√™t'), 3000);
        
        // Afficher un message de succ√®s d√©taill√©
        const successMsg = `PDF d'audit g√©n√©r√© avec succ√®s !\n\nFichier: ${fileName}\nPages: ${pageCount}\n√âl√©ments: ${data.servers.length} serveurs, ${calculateDetailedStats().accountCount} comptes, ${calculateDetailedStats().identityCount} identit√©s\n\nLe document est pr√™t pour signature et archivage.`;
        setTimeout(() => alert(successMsg), 500);
        
    } catch (error) {
        console.error('Erreur lors de la g√©n√©ration du PDF:', error);
        updateConnectionIndicator('‚ùå Erreur g√©n√©ration PDF');
        setTimeout(() => updateConnectionIndicator('‚úì Pr√™t'), 3000);
        
        const errorMsg = `Erreur lors de la g√©n√©ration du PDF:\n\n${error.message}\n\nVeuillez v√©rifier:\n‚Ä¢ Que des donn√©es sont pr√©sentes dans la cartographie\n‚Ä¢ Votre navigateur supporte les fonctions PDF\n‚Ä¢ R√©essayez dans quelques secondes`;
        alert(errorMsg);
    }
}

// Fonctions utilitaires pour le PDF
function formatDate(dateString) {
    if (!dateString) return 'Non sp√©cifi√©';
    return new Date(dateString).toLocaleDateString('fr-FR');
}

function calculateDetailedStats() {
    const serverCount = data.servers.length;
    const accountCount = data.servers.reduce((total, server) => total + server.accounts.length, 0);
    const identityCount = data.servers.reduce((total, server) => 
        total + server.accounts.reduce((acc, account) => acc + account.identities.length, 0), 0);
    
    const accountsWithIdentities = data.servers.reduce((total, server) => 
        total + server.accounts.filter(account => account.identities.length > 0).length, 0);
    
    const identityCoverage = accountCount > 0 ? Math.round((accountsWithIdentities / accountCount) * 100) : 0;
    
    // Statistiques par OS
    const osSummary = {};
    data.servers.forEach(server => {
        const os = server.os || 'Non sp√©cifi√©';
        osSummary[os] = (osSummary[os] || 0) + 1;
    });
    
    // Statistiques par type de compte
    const accountTypes = {};
    data.servers.forEach(server => {
        server.accounts.forEach(account => {
            const type = account.typeAccount || 'Non sp√©cifi√©';
            accountTypes[type] = (accountTypes[type] || 0) + 1;
        });
    });
    
    return {
        serverCount,
        accountCount,
        identityCount,
        identityCoverage,
        osSummary,
        accountTypes
    };
}

// Test de g√©n√©ration PDF simple (fonction de d√©bogage)
async function testPDFGeneration() {
    const { jsPDF } = window.jspdf;
    
    if (!window.jspdf) {
        alert(' Librairie PDF non disponible');
        return;
    }
    
    try {
        const pdf = new jsPDF();
        pdf.setFontSize(16);
        pdf.text('Test PDF - Cartographie ISO27001', 20, 20);
        pdf.setFontSize(12);
        pdf.text('Ce PDF de test confirme que la g√©n√©ration fonctionne.', 20, 40);
        pdf.text(`G√©n√©r√© le: ${new Date().toLocaleString('fr-FR')}`, 20, 60);
        
        const stats = calculateDetailedStats();
        pdf.text(`Serveurs: ${stats.serverCount}`, 20, 80);
        pdf.text(`Comptes: ${stats.accountCount}`, 20, 95);
        pdf.text(`Identit√©s: ${stats.identityCount}`, 20, 110);
        
        pdf.save('test-pdf-cartographie.pdf');
        updateConnectionIndicator('‚úÖ Test PDF r√©ussi');
        setTimeout(() => updateConnectionIndicator('‚úì Pr√™t'), 2000);
        
    } catch (error) {
        console.error('Test PDF √©chou√©:', error);
        updateConnectionIndicator('‚ùå Test PDF √©chou√©');
        alert('Test PDF √©chou√©: ' + error.message);
    }
}

// ==== Divers ====
function clearAll() { 
    if (confirm("√ätes-vous s√ªr de vouloir tout effacer ?")) { 
        data.servers = []; 
        render(); 
        updateStats();
        updateConnectionIndicator('Cartographie effac√©e');
        setTimeout(() => updateConnectionIndicator('‚úì Pr√™t'), 2000);
    } 
}

function showHelp() {
    const helpText = `üõ°Ô∏è CARTOGRAPHIE ISO27001 - GUIDE D'UTILISATION

üìã FONCTIONS PRINCIPALES:
‚Ä¢ Serveur : Cr√©ez des serveurs (rectangles violets)
‚Ä¢ Compte : Cliquez sur un serveur pour ajouter un compte (rectangles bleus)
‚Ä¢ Identit√© : Cliquez sur un compte pour ajouter une identit√© (rectangles verts)

üéÆ NAVIGATION:
‚Ä¢ Ctrl + Molette souris : Zoom avant/arri√®re
‚Ä¢ Clic + Glisser sur fond : D√©placer la vue
‚Ä¢ Clic sur n≈ìud : Ajouter un √©l√©ment enfant
‚Ä¢ Croix rouge : Supprimer l'√©l√©ment

üíæ GESTION DES DONN√âES:
‚Ä¢ Export JSON : Sauvegarde compl√®te
‚Ä¢ Import JSON : Restauration des donn√©es
‚Ä¢ Export Draw.io : Compatible avec Draw.io
‚Ä¢ G√©rer listes : Personnaliser les options

üéØ WORKFLOW RECOMMAND√â:
1. Cr√©er les serveurs principaux
2. Ajouter les comptes pour chaque serveur
3. Associer les identit√©s aux comptes
4. Sauvegarder r√©guli√®rement

‚öôÔ∏è PERSONNALISATION:
‚Ä¢ Utilisez "G√©rer listes" pour adapter les options
‚Ä¢ Les statistiques se mettent √† jour automatiquement
‚Ä¢ La sidebar peut √™tre r√©duite pour plus d'espace

Pour plus d'informations sur ISO27001, consultez la documentation officielle.`;
    
    alert(helpText);
}

// ==== Zoom & Pan (JavaScript original conserv√©) ====
let panX = 0, panY = 0, scale = 1, isPanning = false, startX, startY;
const container = document.getElementById('container');

container.addEventListener('mousedown', e => { 
    if (e.target === container || e.target === svg) {
        isPanning = true; 
        startX = e.clientX - panX; 
        startY = e.clientY - panY; 
        container.style.cursor = 'grabbing'; 
    }
});

container.addEventListener('mouseup', () => { 
    isPanning = false; 
    container.style.cursor = 'grab'; 
});

container.addEventListener('mousemove', e => {
    if (!isPanning) return;
    panX = e.clientX - startX; 
    panY = e.clientY - startY;
    svg.style.transform = `translate(${panX}px,${panY}px) scale(${scale})`;
});

container.addEventListener('wheel', e => {
    if (!e.ctrlKey) return;
    e.preventDefault();
    const rect = container.getBoundingClientRect();
    const centerX = rect.width / 2;
    const centerY = rect.height / 2;
    
    const oldScale = scale;
    scale *= e.deltaY > 0 ? 0.9 : 1.1;
    scale = Math.max(0.1, Math.min(3, scale));
    
    const scaleFactor = scale / oldScale;
    panX = centerX - (centerX - panX) * scaleFactor;
    panY = centerY - (centerY - panY) * scaleFactor;
    
    svg.style.transform = `translate(${panX}px,${panY}px) scale(${scale})`;
}, { passive: false });

// ==== NOUVELLES FONCTIONS AJOUT√âES ====

// Sidebar toggle
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const icon = document.getElementById('sidebarToggleIcon');
    
    sidebarCollapsed = !sidebarCollapsed;
    sidebar.classList.toggle('collapsed', sidebarCollapsed);
    icon.textContent = sidebarCollapsed ? '‚ñ∂' : '‚óÄ';
}

// Mise √† jour des statistiques
function updateStats() {
    const serverCount = data.servers.length;
    const accountCount = data.servers.reduce((total, server) => total + server.accounts.length, 0);
    const identityCount = data.servers.reduce((total, server) => 
        total + server.accounts.reduce((acc, account) => acc + account.identities.length, 0), 0);
    const connectionCount = accountCount + identityCount; // Connexions approximatives
    
    document.getElementById('serverCount').textContent = serverCount;
    document.getElementById('accountCount').textContent = accountCount;
    document.getElementById('identityCount').textContent = identityCount;
    document.getElementById('connectionCount').textContent = connectionCount;
}

// Indicateur de connexion
function updateConnectionIndicator(message) {
    const indicator = document.getElementById('connectionIndicator');
    indicator.textContent = message;
    
    // Animation du pulse
    indicator.style.animation = 'none';
    setTimeout(() => {
        indicator.style.animation = 'pulse 2s infinite';
    }, 10);
}

// Fonctions de zoom suppl√©mentaires
function zoomIn() {
    const event = { 
        ctrlKey: true, 
        deltaY: -100, 
        preventDefault: () => {} 
    };
    container.dispatchEvent(new WheelEvent('wheel', event));
}

function zoomOut() {
    const event = { 
        ctrlKey: true, 
        deltaY: 100, 
        preventDefault: () => {} 
    };
    container.dispatchEvent(new WheelEvent('wheel', event));
}

function resetZoom() {
    scale = 1;
    panX = 0;
    panY = 0;
    svg.style.transform = `translate(${panX}px,${panY}px) scale(${scale})`;
}

function centerView() {
    if (data.servers.length === 0) {
        updateConnectionIndicator('Aucun √©l√©ment √† centrer');
        setTimeout(() => updateConnectionIndicator('‚úì Pr√™t'), 1500);
        return;
    }
    
    // Calculer le centre approximatif du contenu
    const containerRect = container.getBoundingClientRect();
    const centerX = containerRect.width / 2;
    const centerY = containerRect.height / 2;
    
    // Approximation simple du centre du contenu
    const contentCenterX = data.servers.length * 90; // Estimation
    const contentCenterY = 200; // Estimation bas√©e sur la structure
    
    panX = centerX - contentCenterX;
    panY = centerY - contentCenterY;
    
    svg.style.transform = `translate(${panX}px,${panY}px) scale(${scale})`;
    
    updateConnectionIndicator('Vue centr√©e');
    setTimeout(() => updateConnectionIndicator('‚úì Pr√™t'), 1500);
}

// Gestion des √©v√©nements du redimensionnement
window.addEventListener('resize', () => {
    render();
    updateStats();
});

// Fermer les modales en cliquant √† l'ext√©rieur
document.addEventListener('click', (e) => {
    if (e.target.classList.contains('modal')) {
        e.target.style.display = 'none';
    }
});

// Gestion des raccourcis clavier
document.addEventListener('keydown', (e) => {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
        return;
    }
    
    switch(e.key) {
        case 'Escape':
            // Fermer toutes les modales
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
            break;
        case 'h':
        case 'H':
            showHelp();
            break;
        case 's':
        case 'S':
            if (e.ctrlKey) {
                e.preventDefault();
                exportJSON();
            }
            break;
    }
});

// Initialisation
window.addEventListener('load', () => {
    render();
    updateStats();
    updateConnectionIndicator('‚úì Application pr√™te');
    
    // V√©rifier les librairies PDF
    checkPDFLibraries();
    
    // Masquer l'aide apr√®s quelques secondes
    setTimeout(() => {
        const helpTooltip = document.querySelector('.help-tooltip');
        if (helpTooltip) {
            helpTooltip.style.opacity = '0';
            setTimeout(() => {
                helpTooltip.style.display = 'none';
            }, 500);
        }
    }, 10000);
});

// V√©rification des librairies PDF
function checkPDFLibraries() {
    const systemStatus = document.getElementById('systemStatus');
    const libStatus = document.getElementById('libStatus');
    
    if (systemStatus && libStatus) {
        let status = '‚úÖ Syst√®me op√©rationnel';
        let libStatusText = '';
        
        if (window.jspdf) {
            libStatusText += '‚úÖ jsPDF ';
        } else {
            libStatusText += '‚ùå jsPDF ';
            status = '‚ö†Ô∏è Librairies manquantes';
        }
        
        if (window.html2canvas) {
            libStatusText += '‚úÖ html2canvas';
        } else {
            libStatusText += '‚ùå html2canvas';
            status = '‚ö†Ô∏è Librairies manquantes';
        }
        
        systemStatus.textContent = status;
        libStatus.textContent = libStatusText;
        
        if (status.includes('manquantes')) {
            setTimeout(() => {
                systemStatus.innerHTML = '‚ö†Ô∏è Rechargez la page<br>si PDF ne fonctionne pas';
            }, 3000);
        }
    }
}

function generateDocumentHash() {
    // G√©n√©ration d'un hash simple bas√© sur le contenu
    const content = JSON.stringify(data) + new Date().toDateString();
    let hash = 0;
    for (let i = 0; i < content.length; i++) {
        const char = content.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convertir en 32bit integer
    }
    return Math.abs(hash).toString(16).toUpperCase();
}

console.log('Cartographie ISO27001 - Version am√©lior√©e initialis√©e');
</script>

</body>
</html>
