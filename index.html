<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cartographie Comptes Privil√©gi√©s ISO27001</title>
<style>
    :root {
        --primary: #667eea;
        --primary-dark: #5a67d8;
        --secondary: #764ba2;
        --success: #48bb78;
        --danger: #f56565;
        --warning: #ed8936;
        --info: #4299e1;
        --dark: #2d3748;
        --light: #f7fafc;
        --gray: #718096;
        --border: #e2e8f0;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    * {
        box-sizing: border-box;
    }

    body {
        margin: 0;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        overflow: hidden;
        color: var(--dark);
    }

    .header {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid var(--border);
        padding: 1rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: var(--shadow);
        z-index: 1000;
        position: relative;
    }

    .logo {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 1.4rem;
        font-weight: 700;
        color: var(--primary);
    }

    .logo::before {
        content: "üõ°Ô∏è";
        font-size: 2rem;
        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
    }

    .toolbar {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        flex-wrap: wrap;
    }

    .btn {
        background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        border: none;
        padding: 0.75rem 1.25rem;
        border-radius: 10px;
        color: white;
        font-weight: 600;
        cursor: pointer;
        box-shadow: var(--shadow);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
        text-decoration: none;
        position: relative;
        overflow: hidden;
    }

    .btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s;
    }

    .btn:hover {
        transform: translateY(-2px) scale(1.02);
        box-shadow: var(--shadow-lg);
    }

    .btn:hover::before {
        left: 100%;
    }

    .btn:active {
        transform: translateY(0) scale(0.98);
    }

    .btn-success {
        background: linear-gradient(135deg, var(--success), #38a169);
    }

    .btn-warning {
        background: linear-gradient(135deg, var(--warning), #dd6b20);
    }

    .btn-danger {
        background: linear-gradient(135deg, var(--danger), #e53e3e);
    }

    .btn-secondary {
        background: linear-gradient(135deg, var(--gray), #4a5568);
    }

    .main-container {
        display: flex;
        height: calc(100vh - 90px);
        position: relative;
    }

    .sidebar {
        width: 320px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(15px);
        border-right: 1px solid var(--border);
        padding: 1.5rem;
        overflow-y: auto;
        box-shadow: var(--shadow);
        transition: transform 0.3s ease;
        z-index: 100;
    }

    .sidebar.collapsed {
        transform: translateX(-300px);
    }

    .sidebar-toggle {
        position: absolute;
        top: 1rem;
        right: -45px;
        background: var(--primary);
        color: white;
        border: none;
        width: 45px;
        height: 45px;
        border-radius: 0 12px 12px 0;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: var(--shadow);
        z-index: 101;
        transition: all 0.3s ease;
        font-size: 1.2rem;
    }

    .sidebar-toggle:hover {
        background: var(--primary-dark);
        transform: scale(1.05);
    }

    .stats-panel {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(247, 250, 252, 0.8));
        backdrop-filter: blur(10px);
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: var(--shadow);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .stats-panel h3 {
        margin: 0 0 1rem 0;
        color: var(--primary);
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }

    .stat-item {
        text-align: center;
        padding: 1rem;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.8), rgba(237, 242, 247, 0.6));
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .stat-item:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow);
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 800;
        color: var(--primary);
        display: block;
        text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .stat-label {
        font-size: 0.85rem;
        color: var(--gray);
        margin-top: 0.25rem;
        font-weight: 500;
    }

    .controls-section {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(247, 250, 252, 0.8));
        backdrop-filter: blur(10px);
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: var(--shadow);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .controls-section h3 {
        margin: 0 0 1rem 0;
        color: var(--primary);
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .control-group {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .canvas-container {
        flex: 1;
        position: relative;
        background: radial-gradient(circle at 25% 25%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                    radial-gradient(circle at 75% 75%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                    linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
        backdrop-filter: blur(5px);
        overflow: hidden;
        cursor: grab;
        border-radius: 0;
    }

    .canvas-container:active {
        cursor: grabbing;
    }

    #container {
        width: 100%;
        height: 100%;
        position: relative;
    }

    svg {
        width: 100%;
        height: 100%;
        background: transparent;
    }

    .server {
        fill: url(#serverGradient);
        stroke: #8e44ad;
        stroke-width: 2;
        filter: drop-shadow(0 4px 8px rgba(142, 68, 173, 0.3));
        transition: all 0.3s ease;
    }

    .server:hover {
        filter: drop-shadow(0 6px 12px rgba(142, 68, 173, 0.4));
        transform: scale(1.02);
    }

    .account {
        fill: url(#accountGradient);
        stroke: #2980b9;
        stroke-width: 2;
        filter: drop-shadow(0 4px 8px rgba(41, 128, 185, 0.3));
        transition: all 0.3s ease;
    }

    .account:hover {
        filter: drop-shadow(0 6px 12px rgba(41, 128, 185, 0.4));
        transform: scale(1.02);
    }

    .identity {
        fill: url(#identityGradient);
        stroke: #27ae60;
        stroke-width: 2;
        filter: drop-shadow(0 4px 8px rgba(39, 174, 96, 0.3));
        transition: all 0.3s ease;
    }

    .identity:hover {
        filter: drop-shadow(0 6px 12px rgba(39, 174, 96, 0.4));
        transform: scale(1.02);
    }

    .label {
        font-size: 12px;
        fill: white;
        pointer-events: none;
        font-weight: 600;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.7);
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(8px);
        justify-content: center;
        align-items: center;
        z-index: 2000;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .modal-content {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(247, 250, 252, 0.9));
        backdrop-filter: blur(20px);
        padding: 2rem;
        border-radius: 20px;
        width: min(90vw, 480px);
        max-height: 85vh;
        overflow-y: auto;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        animation: slideIn 0.3s ease;
        position: relative;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-30px) scale(0.9);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    .modal-content h3 {
        margin: 0 0 1.5rem 0;
        color: var(--primary);
        font-size: 1.4rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--border);
    }

    .modal-content label {
        display: block;
        margin: 1.25rem 0 0.5rem 0;
        font-weight: 600;
        color: var(--dark);
        font-size: 0.95rem;
    }

    .modal-content input,
    .modal-content select,
    .modal-content textarea {
        width: 100%;
        padding: 0.875rem;
        border: 2px solid var(--border);
        border-radius: 10px;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(5px);
    }

    .modal-content input:focus,
    .modal-content select:focus,
    .modal-content textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        background: rgba(255, 255, 255, 0.95);
    }

    .modal-content button {
        margin: 1.5rem 0.5rem 0.5rem 0;
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9rem;
    }

    .modal-content button:first-of-type {
        background: linear-gradient(135deg, var(--success), #38a169);
        color: white;
        box-shadow: var(--shadow);
    }

    .modal-content button:first-of-type:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .modal-content button:last-of-type {
        background: linear-gradient(135deg, var(--gray), #4a5568);
        color: white;
        box-shadow: var(--shadow);
    }

    .modal-content button:last-of-type:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .zoom-controls {
        position: absolute;
        bottom: 2rem;
        right: 2rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        z-index: 100;
    }

    .zoom-btn {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border: 1px solid var(--border);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.4rem;
        font-weight: 700;
        color: var(--primary);
        box-shadow: var(--shadow);
        transition: all 0.2s ease;
    }

    .zoom-btn:hover {
        transform: scale(1.1);
        background: white;
        color: var(--primary-dark);
    }

    .help-tooltip {
        position: absolute;
        bottom: 2rem;
        left: 2rem;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 1rem;
        border-radius: 12px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
        font-size: 0.85rem;
        color: var(--gray);
        max-width: 280px;
        animation: slideInLeft 0.5s ease;
    }

    @keyframes slideInLeft {
        from {
            opacity: 0;
            transform: translateX(-20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .connection-indicator {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: var(--success);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }

    /* Scrollbar styling */
    .sidebar::-webkit-scrollbar,
    .modal-content::-webkit-scrollbar {
        width: 6px;
    }

    .sidebar::-webkit-scrollbar-track,
    .modal-content::-webkit-scrollbar-track {
        background: rgba(0,0,0,0.1);
        border-radius: 3px;
    }

    .sidebar::-webkit-scrollbar-thumb,
    .modal-content::-webkit-scrollbar-thumb {
        background: var(--primary);
        border-radius: 3px;
    }

    .sidebar::-webkit-scrollbar-thumb:hover,
    .modal-content::-webkit-scrollbar-thumb:hover {
        background: var(--primary-dark);
    }

    @media (max-width: 768px) {
        .header {
            padding: 1rem;
            flex-direction: column;
            gap: 1rem;
        }

        .logo {
            font-size: 1.2rem;
        }

        .toolbar {
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.6rem 1rem;
            font-size: 0.85rem;
        }

        .sidebar {
            width: 300px;
        }

        .modal-content {
            width: 95vw;
            padding: 1.5rem;
            border-radius: 16px;
        }

        .zoom-controls, .help-tooltip {
            display: none;
        }

        .main-container {
            height: calc(100vh - 140px);
        }
    }

    @media (max-width: 480px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }
        
        .toolbar {
            gap: 0.25rem;
        }
        
        .btn {
            padding: 0.5rem 0.75rem;
            font-size: 0.8rem;
        }
    }
</style>
</head>
<body>

<!-- Header -->
<div class="header">
    <div class="logo">
        Cartographie des acc√®s
    </div>
    <div class="toolbar">
        <button class="btn btn-success" onclick="openAddServerModal()">
            üñ•Ô∏è Serveur
        </button>
        <button class="btn" onclick="openManageListsModal()">
            ‚öôÔ∏è Listes
        </button>
        <button class="btn btn-secondary" onclick="exportJSON()">
            üíæ JSON
        </button>
        <button class="btn" onclick="exportDrawio()">
            üì§ Draw.io
        </button>
        <button class="btn btn-success" onclick="generateAuditPDF()">
            üìã PDF Audit
        </button>
        <button class="btn btn-warning" onclick="importJSON()">
            üìÅ Importer
        </button>
        <button class="btn btn-danger" onclick="clearAll()">
            üóëÔ∏è Effacer
        </button>
        <button class="btn btn-secondary" onclick="showHelp()">
            ‚ùì Aide
        </button>
        <button class="btn btn-secondary" onclick="exportSVG()">
            üñºÔ∏è SVG
        </button>
    </div>
</div>

<!-- Main Container -->
<div class="main-container">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <button class="sidebar-toggle" onclick="toggleSidebar()">
            <span id="sidebarToggleIcon">‚óÄ</span>
        </button>

        <!-- Statistics -->
        <div class="stats-panel" id="statsPanel">
            <h3>üìä Statistiques</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-value" id="serverCount">0</span>
                    <span class="stat-label">Serveurs</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="accountCount">0</span>
                    <span class="stat-label">Comptes</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="identityCount">0</span>
                    <span class="stat-label">Identit√©s</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="connectionCount">0</span>
                    <span class="stat-label">Connexions</span>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <!-- Pagination Controls -->
        <div class="controls-section">
            <h3>üìÑ Pagination</h3>
            <div class="control-group">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                    <button id="prevPageBtn" class="btn btn-secondary" onclick="changePage(-1)" style="flex: 1;">‚óÄ Prec</button>
                    <span id="pageInfo" style="font-weight: 600; color: var(--primary);">1/1</span>
                    <button id="nextPageBtn" class="btn btn-secondary" onclick="changePage(1)" style="flex: 1;">Suiv ‚ñ∂</button>
                </div>
                <div style="font-size: 0.8rem; color: var(--gray); text-align: center;">
                    <span id="pageElementCount">0 serveurs affich√©s</span>
                </div>
            </div>
        </div>
        
        <div class="controls-section">
            <h3>üéõÔ∏è Contr√¥les rapides</h3>
            <div class="control-group">
                <button class="btn" onclick="centerView()" style="width: 100%; justify-content: center;">
                    üéØ Centrer la vue
                </button>
                <button class="btn btn-secondary" onclick="resetZoom()" style="width: 100%; justify-content: center;">
                    üîÑ R√©initialiser zoom
                </button>
            </div>
        </div>

        <!-- Quick Help -->
        <div class="controls-section">
            <h3>üí° Raccourcis</h3>
            <div style="font-size: 0.85rem; color: var(--gray); line-height: 1.4;">
                <p><strong>Ctrl + Molette :</strong> Zoom</p>
                <p><strong>Clic + Glisser :</strong> D√©placer</p>
                <p><strong>Clic sur n≈ìud :</strong> Ajouter enfant</p>
                <p><strong>Croix rouge :</strong> Supprimer</p>
            </div>
        </div>

        <!-- PDF Audit Section -->
        <div class="controls-section">
            <h3>üìã Audit & Conformit√©</h3>
            <div class="control-group">
                <button class="btn btn-success" onclick="generateAuditPDF()" style="width: 100%; justify-content: center;">
                    üìã G√©n√©rer PDF d'audit
                </button>
                <button class="btn btn-secondary" onclick="testPDFGeneration()" style="width: 100%; justify-content: center; font-size: 0.8rem; margin-top: 0.5rem;">
                    üß™ Test PDF
                </button>
                <div style="font-size: 0.8rem; color: var(--gray); margin-top: 0.5rem; text-align: center;">
                    Document officiel avec<br>section de signature
                </div>
            </div>
        </div>

        <div class="controls-section">
            <h3>‚ÑπÔ∏è √âtat du syst√®me</h3>
            <div style="font-size: 0.85rem; color: var(--gray); line-height: 1.4;">
                <p id="systemStatus">üîÑ V√©rification...</p>
                <p id="pdfLibStatus">üìö Librairies: <span id="libStatus">En cours...</span></p>
            </div>
        </div>
    </div>

    <!-- Canvas -->
    <div class="canvas-container">
        <div id="container">
            <svg id="svgCanvas">
                <defs>
                    <linearGradient id="serverGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#9b59b6;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#8e44ad;stop-opacity:1" />
                    </linearGradient>
                    <linearGradient id="accountGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#3498db;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#2980b9;stop-opacity:1" />
                    </linearGradient>
                    <linearGradient id="identityGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#2ecc71;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#27ae60;stop-opacity:1" />
                    </linearGradient>
                </defs>
            </svg>
        </div>

        <!-- Zoom Controls -->
        <div class="zoom-controls">
            <button class="zoom-btn" onclick="zoomIn()" title="Zoom avant">+</button>
            <button class="zoom-btn" onclick="zoomOut()" title="Zoom arri√®re">‚àí</button>
            <button class="zoom-btn" onclick="resetZoom()" title="Vue d'ensemble">‚åÇ</button>
        </div>

        <!-- Help Tooltip -->
        <div class="help-tooltip">
            <strong>üöÄ D√©marrage rapide</strong><br>
            1. Ajoutez un serveur<br>
            2. Cliquez dessus pour ajouter un compte<br>
            3. Cliquez sur le compte pour ajouter une identit√©
        </div>

        <!-- Connection Indicator -->
        <div class="connection-indicator" id="connectionIndicator">
            ‚úì Application pr√™te
        </div>
    </div>
</div>

<!-- Modal Serveur -->
<div class="modal" id="serverModal">
    <div class="modal-content">
        <h3>üñ•Ô∏è Ajouter un serveur</h3>
        <label>Nom du serveur :</label>
        <input type="text" id="serverName" placeholder="Ex: SRV-WEB-01">
        <label>Syst√®me d'exploitation :</label>
        <select id="serverOS"></select>
        <label>Logiciel principal :</label>
        <select id="serverSoftware"></select>
        <button onclick="confirmAddServer()">Ajouter le serveur</button>
        <button onclick="closeModal('serverModal')">Annuler</button>
    </div>
</div>

<!-- Modal Compte -->
<div class="modal" id="accountModal">
    <div class="modal-content">
        <h3>üë§ Ajouter un compte</h3>
        <label>Nom du compte :</label>
        <input type="text" id="accountName" placeholder="Ex: admin_db">
        <label>Privil√®ges :</label>
        <input type="text" id="accountRights" placeholder="Ex: Administrateur syst√®me">
        <label>Type d'acc√®s :</label>
        <select id="accountTypeAccess"></select>
        <label>M√©thode d'authentification :</label>
        <select id="accountAuthMethod"></select>
        <label>Type de compte :</label>
        <select id="accountType"></select>
        <button onclick="confirmAddAccount()">Ajouter le compte</button>
        <button onclick="closeModal('accountModal')">Annuler</button>
    </div>
</div>

<!-- Modal Identit√© -->
<div class="modal" id="identityModal">
    <div class="modal-content">
        <h3>üÜî Ajouter une identit√©</h3>
        <label>Nom de la personne :</label>
        <input type="text" id="identityName" placeholder="Ex: Jean Dupont">
        <label>R√¥le :</label>
        <select id="identityRole"></select>
        <label>Justification :</label>
        <select id="identityJustification"></select>
        <label>Date derni√®re revue :</label>
        <input type="date" id="identityLastReview">
        <label>Date prochaine revue :</label>
        <input type="date" id="identityNextReview">
        <button onclick="confirmAddIdentity()">Ajouter l'identit√©</button>
        <button onclick="closeModal('identityModal')">Annuler</button>
    </div>
</div>

<!-- Modal Listes -->
<div class="modal" id="listsModal">
    <div class="modal-content">
        <h3>‚öôÔ∏è G√©rer les listes</h3>
        <label>Syst√®mes d'exploitation (un par ligne) :</label>
        <textarea id="osListEdit" rows="4" placeholder="Windows Server 2022&#10;Ubuntu 22.04&#10;Debian 12"></textarea>
        <label>Logiciels (un par ligne) :</label>
        <textarea id="softwareListEdit" rows="4" placeholder="SQL Server&#10;Apache&#10;Nginx"></textarea>
        <label>Types d'acc√®s (un par ligne) :</label>
        <textarea id="typeAccessListEdit" rows="3" placeholder="Administration&#10;Lecture seule&#10;Application"></textarea>
        <label>M√©thodes d'authentification (un par ligne) :</label>
        <textarea id="authMethodListEdit" rows="4" placeholder="MFA&#10;Mot de passe&#10;Certificat&#10;SSO"></textarea>
        <label>Types de compte (un par ligne) :</label>
        <textarea id="typeAccountListEdit" rows="4" placeholder="Personnel&#10;Partag√©&#10;Service&#10;Application"></textarea>
        <label>R√¥les (un par ligne) :</label>
        <textarea id="roleListEdit" rows="4" placeholder="Admin syst√®me&#10;DBA&#10;Support&#10;DevOps"></textarea>
        <label>Justifications (un par ligne) :</label>
        <textarea id="justificationListEdit" rows="3" placeholder="Projet X&#10;Maintenance&#10;Urgence"></textarea>
        <button onclick="saveLists()">Enregistrer les modifications</button>
        <button onclick="closeModal('listsModal')">Fermer</button>
    </div>
</div>

<!-- Modal PDF Audit -->
<div class="modal" id="pdfAuditModal">
    <div class="modal-content" style="max-width: 600px;">
        <h3>üìã G√©n√©ration PDF d'Audit ISO27001</h3>
        
        <div class="form-group">
            <label>Titre du document :</label>
            <input type="text" id="pdfTitle" class="form-control" value="Cartographie des Comptes Privil√©gi√©s" placeholder="Titre du rapport d'audit">
        </div>
        
        <div class="form-group">
            <label>P√©riode d'audit :</label>
            <div style="display: flex; gap: 1rem;">
                <input type="date" id="auditDateFrom" class="form-control" style="flex: 1;">
                <input type="date" id="auditDateTo" class="form-control" style="flex: 1;">
            </div>
        </div>
        
        <div class="form-group">
            <label>Auditeur responsable :</label>
            <input type="text" id="auditorName" class="form-control" placeholder="Nom de l'auditeur">
        </div>
        
        <div class="form-group">
            <label>Organisation :</label>
            <input type="text" id="organizationName" class="form-control" placeholder="Nom de l'organisation">
        </div>
        
        <div class="form-group">
            <label>Commentaires audit :</label>
            <textarea id="auditComments" class="form-control" rows="3" placeholder="Observations, recommandations, points d'attention..."></textarea>
        </div>
        
        <div class="form-group">
            <label>Classification :</label>
            <select id="documentClassification" class="form-control">
                <option value="CONFIDENTIEL">üîí CONFIDENTIEL</option>
                <option value="RESTREINT">‚ö†Ô∏è RESTREINT</option>
                <option value="INTERNE">üè¢ USAGE INTERNE</option>
                <option value="PUBLIC">üåê PUBLIC</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>
                <input type="checkbox" id="includeSignatureSection" checked>
                Inclure section de signature pour validation
            </label>
        </div>
        
        <div class="form-group">
            <label>
                <input type="checkbox" id="includeStatistics" checked>
                Inclure statistiques d√©taill√©es
            </label>
        </div>
        
        <div class="form-group">
            <label>
                <input type="checkbox" id="includeMetadata" checked>
                Inclure m√©tadonn√©es techniques
            </label>
        </div>
        
        <div style="display: flex; gap: 1rem; margin-top: 2rem; justify-content: flex-end;">
            <button class="btn btn-secondary" onclick="closeModal('pdfAuditModal')">Annuler</button>
            <button class="btn btn-success" onclick="confirmGenerateAuditPDF()">üìã G√©n√©rer le PDF</button>
        </div>
    </div>
</div>

<input type="file" id="fileInput" style="display:none" accept=".json">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
// Donn√©es existantes (gard√©es telles quelles)
let data = { 
    servers: [], 
    settings: {
        osList: ["Windows Server 2022", "Ubuntu 22.04", "Debian 12"],
        softwareList: ["SQL Server", "Apache", "Nginx"],
        typeAccessList: ["Administration", "Lecture seule", "Application"],
        authMethodList: ["MFA", "Mot de passe", "Certificat", "SSO"],
        typeAccountList: ["Personnel", "Partag√©", "Service", "Application"],
        roleList: ["Admin syst√®me", "DBA", "Support", "DevOps"],
        justificationList: ["Projet X", "Maintenance", "Urgence"]
    }
};
const svg = document.getElementById('svgCanvas');

// Gestionnaire de clic sur zone vide pour ajout rapide
svg.addEventListener('click', (e) => {
    // Check for clickable elements first (event delegation for pagination)
    const clickableElement = e.target.closest('[data-clickable="true"]');
    if (clickableElement) {
        const elementId = clickableElement.getAttribute('data-element-id');
        if (elementId && elementClickHandlers.has(elementId)) {
            const handler = elementClickHandlers.get(elementId);
            handler(e);
            return;
        }
    }
    
    // V√©rifier que ce n'est pas un clic sur un √©l√©ment existant
    if (e.target === svg) {
        const rect = svg.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        showEmptyAreaContextMenu(x, y);
    }
});

// Variables pour les nouvelles fonctionnalit√©s
let sidebarCollapsed = false;

// Variables de pagination
let currentPage = 1;
let serversPerPage = 6; // Nombre de serveurs par page
let maxTotalPages = 1;

// Map to store click handlers for pagination persistence
let elementClickHandlers = new Map();

// ==== Fonctions modales et ajout (JavaScript original conserv√©) ====
function openAddServerModal() {
    currentServerId = null; // Reset pour mode ajout
    document.getElementById('serverName').value = "";
    populateSelect('serverOS', data.settings.osList, true);
    populateSelect('serverSoftware', data.settings.softwareList, true);
    
    // R√©initialiser le titre et le bouton pour le mode ajout
    const modal = document.getElementById('serverModal');
    modal.querySelector('h3').textContent = 'üñ•Ô∏è Ajouter un serveur';
    modal.querySelector('button[onclick="confirmAddServer()"]').textContent = 'Ajouter le serveur';
    
    modal.style.display = 'flex';
    updateConnectionIndicator('Ajout d\'un serveur...');
}

function confirmAddServer() {
    if (currentServerId && data.servers.find(s => s.id === currentServerId)) {
        // Mode modification
        const server = data.servers.find(s => s.id === currentServerId);
        const oldValues = { os: server.os, software: server.software };
        
        server.name = document.getElementById('serverName').value.trim();
        server.os = document.getElementById('serverOS').value || "";
        server.software = document.getElementById('serverSoftware').value || "";
        
        if (!server.name) return alert("Nom requis");
        
        // Mettre √† jour les listes si n√©cessaire
        updateListsFromChanges('serverOS', oldValues.os, server.os);
        updateListsFromChanges('serverSoftware', oldValues.software, server.software);
        
        closeModal('serverModal');
        render();
        updateStats();
        updateConnectionIndicator(`Serveur "${server.name}" modifi√©`);
        setTimeout(() => updateConnectionIndicator('‚úì Pr√™t'), 2000);
        currentServerId = null;
    } else {
        // Mode ajout
        const server = {
            id: Date.now(),
            name: document.getElementById('serverName').value.trim(),
            os: document.getElementById('serverOS').value || "",
            software: document.getElementById('serverSoftware').value || "",
            accounts: []
        };
        if (!server.name) return alert("Nom requis");
        
        // Mettre √† jour les listes si n√©cessaire
        updateListsFromChanges('serverOS', null, server.os);
        updateListsFromChanges('serverSoftware', null, server.software);
        
        data.servers.push(server);
        closeModal('serverModal');
        render();
        updateStats();
        updateConnectionIndicator(`Serveur "${server.name}" ajout√©`);
        setTimeout(() => updateConnectionIndicator('‚úì Pr√™t'), 2000);
    }
}

let currentServerId = null;
function openAddAccountModal(serverId) {
    currentServerId = serverId;
    currentAccountId = null; // Reset pour mode ajout
    document.getElementById('accountName').value = "";
    document.getElementById('accountRights').value = "";
    populateSelect('accountTypeAccess', data.settings.typeAccessList, true);
    populateSelect('accountAuthMethod', data.settings.authMethodList, true);
    populateSelect('accountType', data.settings.typeAccountList, true);
    
    // R√©initialiser le titre et le bouton pour le mode ajout
    const modal = document.getElementById('accountModal');
    modal.querySelector('h3').textContent = 'üë§ Ajouter un compte';
    modal.querySelector('button[onclick="confirmAddAccount()"]').textContent = 'Ajouter le compte';
    
    modal.style.display = 'flex';
    updateConnectionIndicator('Ajout d\'un compte...');
}

function confirmAddAccount() {
    const server = data.servers.find(s => s.id === currentServerId);
    
    if (currentAccountId && server.accounts.find(a => a.id === currentAccountId)) {
        // Mode modification
        const account = server.accounts.find(a => a.id === currentAccountId);
        const oldValues = {
            typeAccess: account.typeAccess,
            authMethod: account.authMethod,
            typeAccount: account.typeAccount
        };
        
        account.name = document.getElementById('accountName').value.trim();
        account.rights = document.getElementById('accountRights').value.trim();
        account.typeAccess = document.getElementById('accountTypeAccess').value || "";
        account.authMethod = document.getElementById('accountAuthMethod').value || "";
        account.typeAccount = document.getElementById('accountType').value || "";
        
        if (!account.name) return alert("Nom requis");
        
        // Mettre √† jour les listes si n√©cessaire
        updateListsFromChanges('accountTypeAccess', oldValues.typeAccess, account.typeAccess);
        updateListsFromChanges('accountAuthMethod', oldValues.authMethod, account.authMethod);
        updateListsFromChanges('accountType', oldValues.typeAccount, account.typeAccount);
        
        closeModal('accountModal');
        render();
        updateStats();
        updateConnectionIndicator(`Compte "${account.name}" modifi√©`);
        setTimeout(() => updateConnectionIndicator('‚úì Pr√™t'), 2000);
        currentAccountId = null;
    } else {
        // Mode ajout
        const account = {
            id: Date.now(),
            name: document.getElementById('accountName').value.trim(),
            rights: document.getElementById('accountRights').value.trim(),
            typeAccess: document.getElementById('accountTypeAccess').value || "",
            authMethod: document.getElementById('accountAuthMethod').value || "",
            typeAccount: document.getElementById('accountType').value || "",
            identities: []
        };
        if (!account.name) return alert("Nom requis");
        
        // Mettre √† jour les listes si n√©cessaire
        updateListsFromChanges('accountTypeAccess', null, account.typeAccess);
        updateListsFromChanges('accountAuthMethod', null, account.authMethod);
        updateListsFromChanges('accountType', null, account.typeAccount);
        
        server.accounts.push(account);
        closeModal('accountModal');
        render();
        updateStats();
        updateConnectionIndicator(`Compte "${account.name}" ajout√©`);
        setTimeout(() => updateConnectionIndicator('‚úì Pr√™t'), 2000);
    }
}

let currentAccountId = null;
let currentIdentityId = null;

// ==== FONCTIONS DE MODIFICATION ====
function openEditServerModal(serverId) {
    const server = data.servers.find(s => s.id === serverId);
    if (!server) return;
    
    document.getElementById('serverName').value = server.name;
    populateSelect('serverOS', data.settings.osList, true, server.os);
    populateSelect('serverSoftware', data.settings.softwareList, true, server.software);
    
    // Changer le titre et le bouton pour le mode √©dition
    const modal = document.getElementById('serverModal');
    modal.querySelector('h3').textContent = '‚úèÔ∏è Modifier le serveur';
    modal.querySelector('button[onclick="confirmAddServer()"]').textContent = 'Modifier le serveur';
    
    currentServerId = serverId;
    modal.style.display = 'flex';
    updateConnectionIndicator('Modification serveur...');
}

function openEditAccountModal(serverId, accountId) {
    const server = data.servers.find(s => s.id === serverId);
    const account = server.accounts.find(a => a.id === accountId);
    if (!account) return;
    
    currentServerId = serverId;
    currentAccountId = accountId;
    
    document.getElementById('accountName').value = account.name;
    document.getElementById('accountRights').value = account.rights;
    populateSelect('accountTypeAccess', data.settings.typeAccessList, true, account.typeAccess);
    populateSelect('accountAuthMethod', data.settings.authMethodList, true, account.authMethod);
    populateSelect('accountType', data.settings.typeAccountList, true, account.typeAccount);
    
    // Changer le titre et le bouton pour le mode √©dition
    const modal = document.getElementById('accountModal');
    modal.querySelector('h3').textContent = '‚úèÔ∏è Modifier le compte';
    modal.querySelector('button[onclick="confirmAddAccount()"]').textContent = 'Modifier le compte';
    
    modal.style.display = 'flex';
    updateConnectionIndicator('Modification compte...');
}

function openEditIdentityModal(serverId, accountId, identityId) {
    const server = data.servers.find(s => s.id === serverId);
    const account = server.accounts.find(a => a.id === accountId);
    const identity = account.identities.find(i => i.id === identityId);
    if (!identity) return;
    
    currentServerId = serverId;
    currentAccountId = accountId;
    currentIdentityId = identityId;
    
    document.getElementById('identityName').value = identity.name;
    populateSelect('identityRole', data.settings.roleList, true, identity.role);
    populateSelect('identityJustification', data.settings.justificationList, true, identity.justification);
    document.getElementById('identityLastReview').value = identity.lastReview;
    document.getElementById('identityNextReview').value = identity.nextReview;
    
    // Changer le titre et le bouton pour le mode √©dition
    const modal = document.getElementById('identityModal');
    modal.querySelector('h3').textContent = '‚úèÔ∏è Modifier l\'identit√©';
    modal.querySelector('button[onclick="confirmAddIdentity()"]').textContent = 'Modifier l\'identit√©';
    
    modal.style.display = 'flex';
    updateConnectionIndicator('Modification identit√©...');
}
function openAddIdentityModal(serverId, accountId) {
    currentServerId = serverId;
    currentAccountId = accountId;
    currentIdentityId = null; // Reset pour mode ajout
    document.getElementById('identityName').value = "";
    populateSelect('identityRole', data.settings.roleList, true);
    populateSelect('identityJustification', data.settings.justificationList, true);
    document.getElementById('identityLastReview').value = "";
    document.getElementById('identityNextReview').value = "";
    
    // R√©initialiser le titre et le bouton pour le mode ajout
    const modal = document.getElementById('identityModal');
    modal.querySelector('h3').textContent = 'üîê Ajouter une identit√©';
    modal.querySelector('button[onclick="confirmAddIdentity()"]').textContent = 'Ajouter l\'identit√©';
    
    modal.style.display = 'flex';
    updateConnectionIndicator('Ajout d\'une identit√©...');
}

function confirmAddIdentity() {
    const server = data.servers.find(s => s.id === currentServerId);
    const account = server.accounts.find(a => a.id === currentAccountId);
    
    if (currentIdentityId && account.identities.find(i => i.id === currentIdentityId)) {
        // Mode modification
        const identity = account.identities.find(i => i.id === currentIdentityId);
        const oldValues = {
            role: identity.role,
            justification: identity.justification
        };
        
        identity.name = document.getElementById('identityName').value.trim();
        identity.role = document.getElementById('identityRole').value || "";
        identity.justification = document.getElementById('identityJustification').value || "";
        identity.lastReview = document.getElementById('identityLastReview').value || "";
        identity.nextReview = document.getElementById('identityNextReview').value || "";
        
        if (!identity.name) return alert("Nom requis");
        
        // Mettre √† jour les listes si n√©cessaire
        updateListsFromChanges('identityRole', oldValues.role, identity.role);
        updateListsFromChanges('identityJustification', oldValues.justification, identity.justification);
        
        closeModal('identityModal');
        render();
        updateStats();
        updateConnectionIndicator(`Identit√© "${identity.name}" modifi√©e`);
        setTimeout(() => updateConnectionIndicator('‚úì Pr√™t'), 2000);
        currentIdentityId = null;
    } else {
        // Mode ajout
        const identity = {
            id: Date.now(),
            name: document.getElementById('identityName').value.trim(),
            role: document.getElementById('identityRole').value || "",
            justification: document.getElementById('identityJustification').value || "",
            lastReview: document.getElementById('identityLastReview').value || "",
            nextReview: document.getElementById('identityNextReview').value || ""
        };
        if (!identity.name) return alert("Nom requis");
        
        // Mettre √† jour les listes si n√©cessaire
        updateListsFromChanges('identityRole', null, identity.role);
        updateListsFromChanges('identityJustification', null, identity.justification);
        
        account.identities.push(identity);
        closeModal('identityModal');
        render();
        updateStats();
        updateConnectionIndicator(`Identit√© "${identity.name}" ajout√©e`);
        setTimeout(() => updateConnectionIndicator('‚úì Pr√™t'), 2000);
    }
}

// ==== Listes ====
function openManageListsModal() {
    document.getElementById('osListEdit').value = data.settings.osList.join("\n");
    document.getElementById('softwareListEdit').value = data.settings.softwareList.join("\n");
    document.getElementById('typeAccessListEdit').value = data.settings.typeAccessList.join("\n");
    document.getElementById('authMethodListEdit').value = data.settings.authMethodList.join("\n");
    document.getElementById('typeAccountListEdit').value = data.settings.typeAccountList.join("\n");
    document.getElementById('roleListEdit').value = data.settings.roleList.join("\n");
    document.getElementById('justificationListEdit').value = data.settings.justificationList.join("\n");
    document.getElementById('listsModal').style.display = 'flex';
}

function saveLists() {
    data.settings.osList = splitList('osListEdit');
    data.settings.softwareList = splitList('softwareListEdit');
    data.settings.typeAccessList = splitList('typeAccessListEdit');
    data.settings.authMethodList = splitList('authMethodListEdit');
    data.settings.typeAccountList = splitList('typeAccountListEdit');
    data.settings.roleList = splitList('roleListEdit');
    data.settings.justificationList = splitList('justificationListEdit');
    
    // Synchroniser avec les √©l√©ments existants
    syncListChanges();
    
    closeModal('listsModal');
    updateConnectionIndicator('Listes mises √† jour');
    setTimeout(() => updateConnectionIndicator('‚úì Pr√™t'), 2000);
}

// ==== SYST√àME DE LIAISON DES LISTES ====
function updateListsFromChanges(fieldType, oldValue, newValue) {
    if (!newValue || newValue.trim() === '') return;
    
    const trimmedValue = newValue.trim();
    
    // Mapping des types de champs vers les listes
    const fieldToListMap = {
        'serverOS': 'osList',
        'serverSoftware': 'softwareList',
        'accountTypeAccess': 'typeAccessList',
        'accountAuthMethod': 'authMethodList',
        'accountType': 'typeAccountList',
        'identityRole': 'roleList',
        'identityJustification': 'justificationList'
    };
    
    const listName = fieldToListMap[fieldType];
    if (!listName || !data.settings[listName]) return;
    
    // Ajouter la nouvelle valeur si elle n'existe pas d√©j√†
    if (!data.settings[listName].includes(trimmedValue)) {
        data.settings[listName].push(trimmedValue);
        console.log(`Ajout de "${trimmedValue}" √† la liste ${listName}`);
    }
}

// Fonction pour synchroniser les changements de liste avec les √©l√©ments existants
function syncListChanges() {
    data.servers.forEach(server => {
        if (server.os && !data.settings.osList.includes(server.os)) {
            data.settings.osList.push(server.os);
        }
        if (server.software && !data.settings.softwareList.includes(server.software)) {
            data.settings.softwareList.push(server.software);
        }
        
        server.accounts.forEach(account => {
            if (account.typeAccess && !data.settings.typeAccessList.includes(account.typeAccess)) {
                data.settings.typeAccessList.push(account.typeAccess);
            }
            if (account.authMethod && !data.settings.authMethodList.includes(account.authMethod)) {
                data.settings.authMethodList.push(account.authMethod);
            }
            if (account.typeAccount && !data.settings.typeAccountList.includes(account.typeAccount)) {
                data.settings.typeAccountList.push(account.typeAccount);
            }
            
            account.identities.forEach(identity => {
                if (identity.role && !data.settings.roleList.includes(identity.role)) {
                    data.settings.roleList.push(identity.role);
                }
                if (identity.justification && !data.settings.justificationList.includes(identity.justification)) {
                    data.settings.justificationList.push(identity.justification);
                }
            });
        });
    });
}

function splitList(id) {
    return document.getElementById(id).value.split("\n").map(s => s.trim()).filter(s => s);
}

// ==== Suppression ====
function deleteNode(type, serverId, accountId, identityId) {
    if (!confirm("Supprimer cet √©l√©ment ?")) return;
    if (type === 'server') {
        data.servers = data.servers.filter(s => s.id !== serverId);
    } else if (type === 'account') {
        const server = data.servers.find(s => s.id === serverId);
        server.accounts = server.accounts.filter(a => a.id !== accountId);
    } else if (type === 'identity') {
        const server = data.servers.find(s => s.id === serverId);
        const account = server.accounts.find(a => a.id === accountId);
        account.identities = account.identities.filter(i => i.id !== identityId);
    }
    render();
    updateStats();
    updateConnectionIndicator('√âl√©ment supprim√©');
    setTimeout(() => updateConnectionIndicator('‚úì Pr√™t'), 1500);
}

// ==== UI ====
function closeModal(id) { 
    document.getElementById(id).style.display = 'none'; 
}

function populateSelect(id, items, addEmpty, selectedValue) {
    const sel = document.getElementById(id);
    sel.innerHTML = "";
    if (addEmpty) sel.innerHTML += '<option value="">-- Aucun --</option>';
    items.forEach(item => {
        const selected = selectedValue === item ? ' selected' : '';
        sel.innerHTML += `<option value="${item}"${selected}>${item}</option>`;
    });
}

// ==== Rendu avec pagination et fl√®ches en T ====
function render() {
    // Clear previous click handlers to avoid memory leaks
    elementClickHandlers.clear();
    
    svg.innerHTML = `
        <defs>
            <linearGradient id="serverGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#9b59b6;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#8e44ad;stop-opacity:1" />
            </linearGradient>
            <linearGradient id="accountGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#3498db;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#2980b9;stop-opacity:1" />
            </linearGradient>
            <linearGradient id="identityGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#2ecc71;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#27ae60;stop-opacity:1" />
            </linearGradient>
            <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                    refX="9" refY="3.5" orient="auto" markerUnits="strokeWidth">
                <polygon points="0 0, 10 3.5, 0 7" fill="#333" />
            </marker>
        </defs>
    `;
    
    // Calculer la pagination
    const totalServers = data.servers.length;
    maxTotalPages = Math.max(1, Math.ceil(totalServers / serversPerPage));
    
    // Ajuster la page actuelle si n√©cessaire
    if (currentPage > maxTotalPages) {
        currentPage = maxTotalPages;
    }
    
    // Obtenir les serveurs √† afficher pour la page actuelle
    const startIndex = (currentPage - 1) * serversPerPage;
    const endIndex = Math.min(startIndex + serversPerPage, totalServers);
    const serversToRender = data.servers.slice(startIndex, endIndex);
    
    // Mise √† jour des contr√¥les de pagination
    updatePaginationControls(serversToRender.length);
    
    // Calculs pour l'espacement am√©lior√©
    const serverSpacing = 120; // Espacement horizontal entre serveurs
    const levelSpacing = 170;  // Espacement vertical entre niveaux augment√©
    const accountSpacing = 240; // Espacement horizontal entre comptes
    const identitySpacing = 280; // Espacement horizontal entre identit√©s augment√©
    
    // Calcul optimis√© de la largeur bas√© sur le contenu r√©el
    const calcRequiredWidth = (accounts) => {
        if (accounts.length === 0) return 500;
        
        // Dimensions et espacements standardis√©s  
        const elementWidth = 320; // Largeur maximale des identit√©s
        const minElementSpacing = 60; // Espacement minimum entre bords des √©l√©ments
        
        // Largeur n√©cessaire pour les comptes
        const accountsWidth = accounts.length * elementWidth + (accounts.length - 1) * minElementSpacing;
        
        // Largeur n√©cessaire pour le niveau identit√©s le plus large
        let maxIdentitiesWidth = 0;
        accounts.forEach(account => {
            if (account.identities.length > 0) {
                const identitiesWidth = account.identities.length * elementWidth + 
                    (account.identities.length - 1) * minElementSpacing;
                maxIdentitiesWidth = Math.max(maxIdentitiesWidth, identitiesWidth);
            }
        });
        
        // Largeur totale = la plus grande entre comptes et identit√©s + marges
        const totalWidth = Math.max(elementWidth, accountsWidth, maxIdentitiesWidth) + 200;
        return totalWidth;
    };
    
    let serverXPosition = 60; // Position de d√©part
    
    serversToRender.forEach((server, serverIndex) => {
        const serverY = 80;
        
        // Initialiser le suivi des positions des identit√©s pour ce serveur
        const serverIdentityPositions = [];
        
        // Calculer la largeur n√©cessaire pour ce serveur
        const requiredWidth = calcRequiredWidth(server.accounts);
        const serverX = serverXPosition + requiredWidth / 2;
        
        // Note: Le serveur sera dessin√© apr√®s le calcul de sa position centr√©e
        
        // Position des comptes
        const accountY = serverY + levelSpacing;
        const accountsStartX = serverXPosition;
        
        // Syst√®me de positionnement intelligent pour √©viter les chevauchements
        const elementWidth = 320; // Largeur maximale des identit√©s pour √©viter les superpositions
        const minSpacing = 60; // Espacement minimum entre bords des √©l√©ments
        
        
        // === PHASE 1: CALCULER TOUTES LES POSITIONS D'IDENTIT√âS ===
        const allIdentityPositions = new Map(); // Map<accountIndex, positions[]>
        let globalIdentityX = serverXPosition + elementWidth; // Commencer apr√®s la zone du serveur
        
        server.accounts.forEach((account, accountIndex) => {
            const identityCount = account.identities.length;
            const positions = [];
            
            if (identityCount > 0) {
                // Calculer les positions pour ce compte en √©vitant les collisions globales
                for (let i = 0; i < identityCount; i++) {
                    // V√©rifier les collisions avec toutes les identit√©s d√©j√† positionn√©es
                    let proposedX = globalIdentityX;
                    let hasCollision = true;
                    
                    while (hasCollision) {
                        hasCollision = false;
                        
                        // V√©rifier contre toutes les identit√©s des comptes pr√©c√©dents
                        for (const [prevAccountIndex, prevPositions] of allIdentityPositions) {
                            for (const existingX of prevPositions) {
                                if (Math.abs(proposedX - existingX) < elementWidth + minSpacing) {
                                    proposedX = existingX + elementWidth + minSpacing;
                                    hasCollision = true;
                                    break;
                                }
                            }
                            if (hasCollision) break;
                        }
                        
                        // V√©rifier contre les identit√©s d√©j√† positionn√©es dans ce compte
                        for (const existingX of positions) {
                            if (Math.abs(proposedX - existingX) < elementWidth + minSpacing) {
                                proposedX = existingX + elementWidth + minSpacing;
                                hasCollision = true;
                                break;
                            }
                        }
                    }
                    
                    positions.push(proposedX);
                    globalIdentityX = Math.max(globalIdentityX, proposedX + elementWidth + minSpacing);
                }
            }
            
            allIdentityPositions.set(accountIndex, positions);
            
            // Ajouter un espacement suppl√©mentaire entre les groupes de comptes
            if (positions.length > 0) {
                const accountSpacingExtra = 80; // Espacement suppl√©mentaire entre comptes augment√©
                globalIdentityX += accountSpacingExtra;
            }
        });

        // === PHASE 1.5: CALCULER LES POSITIONS DES COMPTES BAS√âES SUR LEURS IDENTIT√âS ===
        const accountPositions = [];
        server.accounts.forEach((account, accountIndex) => {
            const identityPositions = allIdentityPositions.get(accountIndex);
            
            if (identityPositions && identityPositions.length > 0) {
                // Positionner le compte au centre de ses identit√©s
                const leftmostIdentity = Math.min(...identityPositions);
                const rightmostIdentity = Math.max(...identityPositions);
                const accountX = (leftmostIdentity + rightmostIdentity) / 2;
                accountPositions[accountIndex] = accountX;
            } else {
                // Si pas d'identit√©s, positionner le compte avec espacement suppl√©mentaire
                const previousAccountX = accountPositions.length > 0 ? 
                    Math.max(...accountPositions.filter(x => x !== undefined)) : serverXPosition;
                const accountSpacingExtra = 140; // Espacement plus large pour comptes sans identit√©s
                const defaultX = previousAccountX + elementWidth + minSpacing + accountSpacingExtra;
                accountPositions[accountIndex] = defaultX;
            }
        });

        // === PHASE 1.6: AJUSTER LA POSITION DU SERVEUR ===
        let serverCenterX = serverX; // Position par d√©faut
        if (accountPositions.length > 0) {
            // Centrer le serveur par rapport √† tous ses comptes
            const leftmostAccount = Math.min(...accountPositions);
            const rightmostAccount = Math.max(...accountPositions);
            serverCenterX = (leftmostAccount + rightmostAccount) / 2;
        }

        // === PHASE 2: RENDU DU SERVEUR (MAINTENANT CENTR√â) ===
        let serverLabel = server.name;
        if (server.os) serverLabel += `\n${server.os}`;
        if (server.software) serverLabel += `\n${server.software}`;
        
        drawNode(serverCenterX, serverY, serverLabel, 'server', 
                (e, mouseX, mouseY) => showContextMenu('server', server.id, null, null, mouseX || serverCenterX, mouseY || serverY), 
                () => deleteNode('server', server.id));

        // === PHASE 2.5: DESSINER LES CONNEXIONS VERS LES COMPTES ===
        if (server.accounts.length > 0) {
            // Ligne verticale principale du serveur (tige du T) - plus longue
            const tJunctionY = accountY - 70; // Augment√© de 50 √† 70
            drawStraightLine(serverCenterX, serverY + 35, serverCenterX, tJunctionY, '#8e44ad');
            
            // Ligne horizontale principale (barre du T) si plusieurs comptes
            if (server.accounts.length > 1) {
                const leftmostX = Math.min(...accountPositions);
                const rightmostX = Math.max(...accountPositions);
                drawStraightLine(leftmostX, tJunctionY, rightmostX, tJunctionY, '#8e44ad');
            }
            
            // Lignes verticales vers chaque compte - plus longues
            server.accounts.forEach((account, accountIndex) => {
                const accountX = accountPositions[accountIndex];
                drawStraightLine(accountX, tJunctionY, accountX, accountY - 40, '#8e44ad'); // Plus long
            });
        }

        // === PHASE 3: RENDU DES COMPTES ET IDENTIT√âS ===
        server.accounts.forEach((account, accountIndex) => {
            const accountX = accountPositions[accountIndex];
            
            // Dessiner le compte
            let accountLabel = account.name;
            if (account.rights) accountLabel += `\n${account.rights}`;
            if (account.typeAccess) accountLabel += `\n${account.typeAccess}`;
            if (account.authMethod) accountLabel += `\n${account.authMethod}`;
            if (account.typeAccount) accountLabel += `\n${account.typeAccount}`;
            
            drawNode(accountX, accountY, accountLabel, 'account',
                    (e, mouseX, mouseY) => showContextMenu('account', server.id, account.id, null, mouseX || accountX, mouseY || accountY),
                    () => deleteNode('account', server.id, account.id));
            
            // Position des identit√©s avec espacement am√©lior√©
            const identityY = accountY + levelSpacing;
            
            const identityPositions = allIdentityPositions.get(accountIndex);
            if (identityPositions && identityPositions.length > 0) {
                // Ligne verticale principale du compte vers les identit√©s (tige du T)
                const identityTJunctionY = identityY - 70;
                drawStraightLine(accountX, accountY + 35, accountX, identityTJunctionY, '#2980b9');
                
                // Calculer les extr√™mes pour la ligne horizontale
                const leftmostX = Math.min(...identityPositions);
                const rightmostX = Math.max(...identityPositions);
                
                // Dessiner la ligne horizontale (barre du T) si plusieurs identit√©s
                if (identityPositions.length > 1) {
                    drawStraightLine(leftmostX, identityTJunctionY, rightmostX, identityTJunctionY, '#2980b9');
                }
                
                // Dessiner chaque identit√© et sa connexion
                account.identities.forEach((identity, identityIndex) => {
                    const identityX = identityPositions[identityIndex];
                    
                    // Ligne de connexion verticale vers l'identit√©
                    drawStraightLine(identityX, identityTJunctionY, identityX, identityY - 40, '#2980b9');
                    
                    // Pr√©parer le label de l'identit√©
                    let identityLabel = identity.name;
                    if (identity.role) identityLabel += `\n${identity.role}`;
                    if (identity.justification) identityLabel += `\n${identity.justification}`;
                    if (identity.lastReview) identityLabel += `\nDerni√®re: ${identity.lastReview}`;
                    if (identity.nextReview) identityLabel += `\nProchaine: ${identity.nextReview}`;
                    
                    // Dessiner l'identit√© avec menu contextuel
                    drawNode(identityX, identityY, identityLabel, 'identity', 
                            (e, mouseX, mouseY) => showContextMenu('identity', server.id, account.id, identity.id, mouseX || identityX, mouseY || identityY),
                            () => deleteNode('identity', server.id, account.id, identity.id));
                });
            }
        });
        
        serverXPosition += requiredWidth + 150; // Espacement entre serveurs √©largi pour les comptes plus espac√©s
    });
    
    // Ajuster la taille du SVG pour contenir tous les √©l√©ments avec plus d'espace
    const totalWidth = Math.max(1800, serverXPosition + 400);
    const totalHeight = Math.max(900, 80 + (levelSpacing * 3) + 250);
    svg.setAttribute('viewBox', `0 0 ${totalWidth} ${totalHeight}`);
    svg.style.width = totalWidth + 'px';
    svg.style.height = totalHeight + 'px';
}

function drawNode(x, y, text, type, onClick, onDelete) {
    const lines = text.split("\n");
    const maxLineLength = Math.max(...lines.map(l => l.length));
    
    // Calcul am√©lior√© de la largeur avec plus d'espace pour le texte
    const charWidth = type === 'identity' ? 9 : 7; // Encore plus d'espace pour les identit√©s
    const minWidth = type === 'identity' ? 180 : 120;
    const maxWidth = type === 'identity' ? 320 : 240;
    
    const width = Math.min(maxWidth, Math.max(minWidth, maxLineLength * charWidth + 20));
    const lineHeight = 16; // Hauteur de ligne augment√©e
    const padding = 12;
    const height = padding * 2 + lines.length * lineHeight;
    
    const g = document.createElementNS("http://www.w3.org/2000/svg","g");
    g.style.cursor = onClick ? 'pointer' : 'default';
    
    const rect = document.createElementNS("http://www.w3.org/2000/svg","rect");
    rect.setAttribute("x", x - width/2); 
    rect.setAttribute("y", y - height/2);
    rect.setAttribute("width", width); 
    rect.setAttribute("height", height);
    rect.setAttribute("rx", 12);
    rect.setAttribute("class", type);
    if (onClick) {
        // Generate unique ID for this element
        const elementId = `${type}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
        
        // Add data attributes for click handling
        g.setAttribute('data-clickable', 'true');
        g.setAttribute('data-type', type);
        g.setAttribute('data-element-id', elementId);
        rect.setAttribute('data-clickable', 'true');
        rect.setAttribute('data-type', type);
        rect.setAttribute('data-element-id', elementId);
        
        // Store the click handler in our map
        elementClickHandlers.set(elementId, function(e) {
            e.stopPropagation();
            console.log(`Clicked on ${type} element (ID: ${elementId})`); // Debug log
            
            // Calculate the correct mouse position relative to the page
            const mouseX = e.clientX;
            const mouseY = e.clientY;
            
            // Call onClick with the actual mouse event for proper positioning
            onClick(e, mouseX, mouseY);
        });
    }
    g.appendChild(rect);
    
    // Am√©lioration du rendu du texte avec meilleur espacement
    lines.forEach((line, i) => {
        const label = document.createElementNS("http://www.w3.org/2000/svg","text");
        label.setAttribute("x", x);
        label.setAttribute("y", y - height/2 + padding + (i + 1) * lineHeight - 2);
        label.setAttribute("text-anchor", "middle");
        label.setAttribute("class", "label");
        
        // Tronquer le texte s'il est trop long pour l'identit√©
        let displayText = line;
        if (type === 'identity' && line.length > 30) {
            displayText = line.substring(0, 27) + '...';
        }
        
        label.textContent = displayText;
        
        // Add click handler to text as well for better UX
        if (onClick) {
            const elementId = g.getAttribute('data-element-id');
            label.style.cursor = 'pointer';
            label.setAttribute('data-clickable', 'true');
            label.setAttribute('data-type', type);
            label.setAttribute('data-element-id', elementId);
        }
        
        g.appendChild(label);
    });
    
    if (onDelete) {
        const del = document.createElementNS("http://www.w3.org/2000/svg","text");
        del.setAttribute("x", x + width/2 - 12);
        del.setAttribute("y", y - height/2 + 15);
        del.setAttribute("fill", "#ff4757");
        del.setAttribute("font-size", "18");
        del.setAttribute("font-weight", "bold");
        del.setAttribute("cursor", "pointer");
        del.textContent = "√ó";
        del.addEventListener('click', e => { e.stopPropagation(); onDelete(); });
        del.addEventListener('mouseenter', () => del.setAttribute('fill', '#ff3838'));
        del.addEventListener('mouseleave', () => del.setAttribute('fill', '#ff4757'));
        g.appendChild(del);
    }
    svg.appendChild(g);
}

// Fonction pour dessiner des lignes droites
function drawStraightLine(x1, y1, x2, y2, color) {
    const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
    line.setAttribute("x1", x1);
    line.setAttribute("y1", y1);
    line.setAttribute("x2", x2);
    line.setAttribute("y2", y2);
    line.setAttribute("stroke", color);
    line.setAttribute("stroke-width", "3");
    line.setAttribute("opacity", "0.9");
    line.setAttribute("stroke-linecap", "round");
    svg.appendChild(line);
}

// Fonction legacy maintenue pour compatibilit√©
function drawLine(x1,y1,x2,y2,color) {
    drawStraightLine(x1, y1, x2, y2, color);
}

// Fonction pour dessiner des lignes en T (angles droits) - legacy
function drawTLine(x1, y1, x2, y2, color) {
    drawStraightLine(x1, y1, x2, y2, color);
}

// ==== JSON (JavaScript original conserv√©) ====
function exportJSON() {
    const blob = new Blob([JSON.stringify(data,null,2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; 
    a.download = `cartographie-iso27001-${new Date().toISOString().split('T')[0]}.json`; 
    a.click();
    URL.revokeObjectURL(url);
    updateConnectionIndicator('Export JSON r√©ussi');
    setTimeout(() => updateConnectionIndicator('‚úì Pr√™t'), 2000);
}

function importJSON() { 
    document.getElementById('fileInput').click(); 
}

document.getElementById('fileInput').addEventListener('change', e => {
    const file = e.target.files[0]; 
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => { 
        try {
            data = JSON.parse(ev.target.result); 
            render(); 
            updateStats();
            updateConnectionIndicator('Import r√©ussi');
            setTimeout(() => updateConnectionIndicator('‚úì Pr√™t'), 2000);
        } catch (error) {
            alert('Erreur lors de l\'import: ' + error.message);
            updateConnectionIndicator('Erreur d\'import');
            setTimeout(() => updateConnectionIndicator('‚úì Pr√™t'), 2000);
        }
    };
    reader.readAsText(file);
});

function exportDrawio() {
    const escapeXml = (unsafe) => {
        if (!unsafe) return '';
        return unsafe
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&apos;');
    };

    // Layout settings
    const serverSpacingX = 120;   // Space between servers
    const accountSpacingY = 180;  // Vertical space between levels
    const accountSpacingX = 220;  // Horizontal space between accounts
    const identitySpacingX = 200; // Horizontal space between identities

    let xml = '<?xml version="1.0" encoding="UTF-8"?><mxfile><diagram name="Privilege Map"><mxGraphModel><root>';
    xml += '<mxCell id="0"/><mxCell id="1" parent="0"/>';
    let cellId = 2;

    data.servers.forEach((s, si) => {
        const serverX = si * serverSpacingX;
        const sid = cellId++;
        xml += `<mxCell id="${sid}" value="${escapeXml(s.name)}${s.os ? '&#xa;' + escapeXml(s.os) : ''}${s.software ? '&#xa;' + escapeXml(s.software) : ''}" style="shape=ellipse;fillColor=#8e44ad;fontColor=#FFFFFF;" vertex="1" parent="1"><mxGeometry x="${serverX}" y="0" width="160" height="60" as="geometry"/></mxCell>`;

        s.accounts.forEach((a, ai) => {
            const accountX = serverX + ai * accountSpacingX;
            const accountY = accountSpacingY;
            const aid = cellId++;
            xml += `<mxCell id="${aid}" value="${escapeXml(a.name)}${a.rights ? '&#xa;' + escapeXml(a.rights) : ''}${a.typeAccess ? '&#xa;' + escapeXml(a.typeAccess) : ''}${a.authMethod ? '&#xa;' + escapeXml(a.authMethod) : ''}${a.typeAccount ? '&#xa;' + escapeXml(a.typeAccount) : ''}" style="shape=ellipse;fillColor=#2980b9;fontColor=#FFFFFF;" vertex="1" parent="1"><mxGeometry x="${accountX}" y="${accountY}" width="160" height="60" as="geometry"/></mxCell>`;
            xml += `<mxCell id="${cellId++}" edge="1" parent="1" source="${sid}" target="${aid}"><mxGeometry relative="1" as="geometry"/></mxCell>`;

            a.identities.forEach((i, ii) => {
                const identityX = accountX + ii * identitySpacingX;
                const identityY = accountSpacingY * 2;
                const iid = cellId++;
                xml += `<mxCell id="${iid}" value="${escapeXml(i.name)}${i.role ? '&#xa;' + escapeXml(i.role) : ''}${i.justification ? '&#xa;' + escapeXml(i.justification) : ''}${i.lastReview ? '&#xa;' + escapeXml(i.lastReview) : ''}${i.nextReview ? '&#xa;' + escapeXml(i.nextReview) : ''}" style="shape=ellipse;fillColor=#27ae60;fontColor=#FFFFFF;" vertex="1" parent="1"><mxGeometry x="${identityX}" y="${identityY}" width="160" height="60" as="geometry"/></mxCell>`;
                xml += `<mxCell id="${cellId++}" edge="1" parent="1" source="${aid}" target="${iid}"><mxGeometry relative="1" as="geometry"/></mxCell>`;
            });
        });
    });

    xml += '</root></mxGraphModel></diagram></mxfile>';

    const blob = new Blob([xml], { type: 'application/xml' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `cartographie-iso27001-${new Date().toISOString().split('T')[0]}.drawio`;
    a.click();
    URL.revokeObjectURL(url);

    updateConnectionIndicator('Export Draw.io r√©ussi');
    setTimeout(() => updateConnectionIndicator('‚úì Pr√™t'), 2000);
}




// geneerate svg
function exportSVG() {
    try {
        const svgElement = document.getElementById('svgCanvas').cloneNode(true);

        // Get CSS from the page
        let css = '';
        document.querySelectorAll('style').forEach(styleEl => {
            css += styleEl.textContent;
        });

        // Create <style> element inside SVG with all CSS
        const styleElement = document.createElementNS('http://www.w3.org/2000/svg', 'style');
        styleElement.setAttribute('type', 'text/css');
        styleElement.textContent = css;
        svgElement.insertBefore(styleElement, svgElement.firstChild);

        // Ensure namespaces
        svgElement.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
        svgElement.setAttribute('xmlns:xlink', 'http://www.w3.org/1999/xlink');

        // Serialize
        const serializer = new XMLSerializer();
        let source = serializer.serializeToString(svgElement);
        source = `<?xml version="1.0" encoding="UTF-8"?>\n` + source;

        // Download
        const blob = new Blob([source], { type: 'image/svg+xml;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `cartographie-iso27001-${new Date().toISOString().split('T')[0]}.svg`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        updateConnectionIndicator('Export SVG r√©ussi');
        setTimeout(() => updateConnectionIndicator('‚úì Pr√™t'), 2000);

    } catch (error) {
        console.error('Erreur export SVG:', error);
        updateConnectionIndicator('‚ùå Erreur export SVG');
        setTimeout(() => updateConnectionIndicator('‚úì Pr√™t'), 2000);
        alert('Erreur lors de la g√©n√©ration du SVG: ' + error.message);
    }
}



// ==== G√âN√âRATION PDF AUDIT ====
function generateAuditPDF() {
    // D√©finir les dates par d√©faut
    const today = new Date();
    const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
    
    document.getElementById('auditDateFrom').value = lastMonth.toISOString().split('T')[0];
    document.getElementById('auditDateTo').value = today.toISOString().split('T')[0];
    document.getElementById('auditorName').value = '';
    document.getElementById('organizationName').value = '';
    document.getElementById('auditComments').value = '';
    
    document.getElementById('pdfAuditModal').style.display = 'flex';
    updateConnectionIndicator('Pr√©paration PDF d\'audit...');
}

async function confirmGenerateAuditPDF() {
    const { jsPDF } = window.jspdf;
    
    // V√©rifier que les librairies sont disponibles
    if (!window.jspdf) {
        alert('Erreur: La librairie PDF n\'est pas charg√©e. Veuillez recharger la page.');
        return;
    }
    
    try {
        updateConnectionIndicator('G√©n√©ration du PDF en cours...');
        closeModal('pdfAuditModal');
        
        // Petite pause pour laisser l'interface se mettre √† jour
        await new Promise(resolve => setTimeout(resolve, 100));
        
        // R√©cup√©rer les donn√©es du formulaire
        const pdfData = {
            title: document.getElementById('pdfTitle').value || 'Cartographie des Comptes Privil√©gi√©s',
            dateFrom: document.getElementById('auditDateFrom').value,
            dateTo: document.getElementById('auditDateTo').value,
            auditor: document.getElementById('auditorName').value || 'Non sp√©cifi√©',
            organization: document.getElementById('organizationName').value || 'Organisation',
            comments: document.getElementById('auditComments').value || '',
            classification: document.getElementById('documentClassification').value,
            includeSignature: document.getElementById('includeSignatureSection').checked,
            includeStats: document.getElementById('includeStatistics').checked,
            includeMeta: document.getElementById('includeMetadata').checked
        };
        
        updateConnectionIndicator('Cr√©ation du document PDF...');
        
        // Cr√©er le PDF
        const pdf = new jsPDF('l', 'mm', 'a4'); // Format paysage
        let yPosition = 20;
        
        // === EN-T√äTE DU DOCUMENT ===
        pdf.setFontSize(20);
        pdf.setFont(undefined, 'bold');
        pdf.text(pdfData.title, 20, yPosition);
        yPosition += 10;
        
        pdf.setFontSize(12);
        pdf.setFont(undefined, 'normal');
        pdf.text(`Audit ISO27001 - ${pdfData.classification}`, 20, yPosition);
        yPosition += 15;
        
        // Ligne de s√©paration
        pdf.setDrawColor(102, 126, 234);
        pdf.setLineWidth(0.5);
        pdf.line(20, yPosition, 277, yPosition);
        yPosition += 10;
        
        // === INFORMATIONS G√âN√âRALES ===
        pdf.setFontSize(14);
        pdf.setFont(undefined, 'bold');
        pdf.text('INFORMATIONS G√âN√âRALES', 20, yPosition);
        yPosition += 8;
        
        pdf.setFontSize(10);
        pdf.setFont(undefined, 'normal');
        pdf.text(`Organisation: ${pdfData.organization}`, 20, yPosition);
        yPosition += 5;
        pdf.text(`Auditeur responsable: ${pdfData.auditor}`, 20, yPosition);
        yPosition += 5;
        pdf.text(`P√©riode d'audit: ${formatDate(pdfData.dateFrom)} au ${formatDate(pdfData.dateTo)}`, 20, yPosition);
        yPosition += 5;
        pdf.text(`Date de g√©n√©ration: ${formatDate(new Date().toISOString().split('T')[0])}`, 20, yPosition);
        yPosition += 10;
        
        // === STATISTIQUES ===
        if (pdfData.includeStats) {
            const stats = calculateDetailedStats();
            
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.text('STATISTIQUES D√âTAILL√âES', 20, yPosition);
            yPosition += 8;
            
            pdf.setFontSize(10);
            pdf.setFont(undefined, 'normal');
            
            pdf.text(`Nombre total de serveurs: ${stats.serverCount}`, 20, yPosition);
            yPosition += 5;
            pdf.text(`Nombre total de comptes: ${stats.accountCount}`, 20, yPosition);
            yPosition += 5;
            pdf.text(`Nombre total d'identit√©s: ${stats.identityCount}`, 20, yPosition);
            yPosition += 5;
            pdf.text(`Taux de couverture identit√©s: ${stats.identityCoverage}%`, 20, yPosition);
            yPosition += 8;
            
            // R√©partition par OS
            pdf.setFont(undefined, 'bold');
            pdf.text('R√©partition par OS:', 20, yPosition);
            yPosition += 5;
            pdf.setFont(undefined, 'normal');
            Object.entries(stats.osSummary).forEach(([os, count]) => {
                pdf.text(`  ‚Ä¢ ${os}: ${count} serveur(s)`, 25, yPosition);
                yPosition += 4;
            });
            yPosition += 5;
            
            // Comptes par type
            pdf.setFont(undefined, 'bold');
            pdf.text('R√©partition des comptes:', 20, yPosition);
            yPosition += 5;
            pdf.setFont(undefined, 'normal');
            Object.entries(stats.accountTypes).forEach(([type, count]) => {
                pdf.text(`  ‚Ä¢ ${type || 'Non sp√©cifi√©'}: ${count} compte(s)`, 25, yPosition);
                yPosition += 4;
            });
            yPosition += 10;
        }
        
        // === INVENTAIRE D√âTAILL√â ===
        pdf.setFontSize(14);
        pdf.setFont(undefined, 'bold');
        pdf.text('INVENTAIRE D√âTAILL√â', 20, yPosition);
        yPosition += 10;
        
        // Section inventaire d√©taill√© d'abord
        data.servers.forEach((server, serverIndex) => {
            // V√©rifier si on a assez de place
            if (yPosition > 180) {
                pdf.addPage();
                yPosition = 20;
            }
            
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'bold');
            pdf.text(`${serverIndex + 1}. SERVEUR: ${server.name}`, 20, yPosition);
            yPosition += 6;
            
            pdf.setFontSize(10);
            pdf.setFont(undefined, 'normal');
            if (server.os) {
                pdf.text(`   OS: ${server.os}`, 25, yPosition);
                yPosition += 4;
            }
            if (server.software) {
                pdf.text(`   Logiciel: ${server.software}`, 25, yPosition);
                yPosition += 4;
            }
            yPosition += 3;
            
            server.accounts.forEach((account, accountIndex) => {
                pdf.setFont(undefined, 'bold');
                pdf.text(`   ${serverIndex + 1}.${accountIndex + 1} Compte: ${account.name}`, 25, yPosition);
                yPosition += 5;
                
                pdf.setFont(undefined, 'normal');
                if (account.rights) pdf.text(`       Privil√®ges: ${account.rights}`, 30, yPosition), yPosition += 4;
                if (account.typeAccess) pdf.text(`       Type d'acc√®s: ${account.typeAccess}`, 30, yPosition), yPosition += 4;
                if (account.authMethod) pdf.text(`       Authentification: ${account.authMethod}`, 30, yPosition), yPosition += 4;
                if (account.typeAccount) pdf.text(`       Type compte: ${account.typeAccount}`, 30, yPosition), yPosition += 4;
                
                account.identities.forEach((identity, identityIndex) => {
                    if (yPosition > 180) {
                        pdf.addPage();
                        yPosition = 20;
                    }
                    
                    pdf.setFont(undefined, 'italic');
                    pdf.text(`        Identit√©: ${identity.name}`, 35, yPosition);
                    yPosition += 4;
                    
                    pdf.setFont(undefined, 'normal');
                    if (identity.role) pdf.text(`          R√¥le: ${identity.role}`, 40, yPosition), yPosition += 4;
                    if (identity.justification) pdf.text(`          Justification: ${identity.justification}`, 40, yPosition), yPosition += 4;
                    if (identity.lastReview) pdf.text(`          Derni√®re revue: ${formatDate(identity.lastReview)}`, 40, yPosition), yPosition += 4;
                    if (identity.nextReview) pdf.text(`          Prochaine revue: ${formatDate(identity.nextReview)}`, 40, yPosition), yPosition += 4;
                });
                yPosition += 3;
            });
            yPosition += 5;
        });

        // === CARTOGRAPHIE VISUELLE ===
        pdf.addPage();
        yPosition = 20;
        
        pdf.setFontSize(14);
        pdf.setFont(undefined, 'bold');
        pdf.text('CARTOGRAPHIE VISUELLE PAR PAGE', 20, yPosition);
        yPosition += 10;
        
        // Sauvegarder la page actuelle et g√©n√©rer des captures pour chaque page
        const originalPage = currentPage;
        const originalServersPerPage = serversPerPage;
        let imgWidth = 240;
        let imgHeight = 100;
        
        // G√©n√©rer une image pour chaque page de serveurs
        const totalPages = Math.max(1, Math.ceil(data.servers.length / serversPerPage));
        
        for (let pageNum = 1; pageNum <= totalPages; pageNum++) {
            // Changer temporairement vers cette page pour le rendu
            currentPage = pageNum;
            render(); // Re-rendre pour cette page
            
            // Attendre un petit d√©lai pour que le rendu se termine
            await new Promise(resolve => setTimeout(resolve, 200));
            
            let imgData = null;
            
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'bold');
            pdf.text(`Page ${pageNum}/${totalPages} - Serveurs ${((pageNum-1)*serversPerPage)+1} √† ${Math.min(pageNum*serversPerPage, data.servers.length)}`, 20, yPosition);
            yPosition += 8;
            
            try {
                // M√©thode 1: Capturer le container complet
                const container = document.getElementById('container');
                const canvas = await html2canvas(container, {
                    backgroundColor: '#ffffff',
                    scale: 0.6,
                    logging: false,
                    useCORS: true,
                    allowTaint: true,
                    foreignObjectRendering: false,
                    imageTimeout: 5000,
                    removeContainer: false
                });
                
                imgData = canvas.toDataURL('image/png');
                imgHeight = Math.min(120, (canvas.height * imgWidth) / canvas.width);
                
            } catch (error) {
                console.warn(`Erreur capture page ${pageNum}:`, error);
                
                // G√©n√©rer un placeholder pour cette page
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = 800;
                tempCanvas.height = 300;
                const ctx = tempCanvas.getContext('2d');
                
                // Fond blanc
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                
                // Bordure
                ctx.strokeStyle = '#667eea';
                ctx.lineWidth = 2;
                ctx.strokeRect(10, 10, tempCanvas.width - 20, tempCanvas.height - 20);
                
                // Titre
                ctx.fillStyle = '#2d3748';
                ctx.font = 'bold 20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`Cartographie - Page ${pageNum}/${totalPages}`, tempCanvas.width / 2, 50);
                
                // Dessiner repr√©sentation des serveurs de cette page
                const startIndex = (pageNum - 1) * serversPerPage;
                const endIndex = Math.min(startIndex + serversPerPage, data.servers.length);
                const pageServers = data.servers.slice(startIndex, endIndex);
                
                ctx.font = '14px Arial';
                ctx.fillStyle = '#8e44ad';
                let xPos = 80;
                pageServers.forEach((server, index) => {
                    ctx.fillRect(xPos, 120, 100, 50);
                    ctx.fillStyle = '#ffffff';
                    ctx.font = 'bold 12px Arial';
                    ctx.fillText(server.name.substring(0, 12), xPos + 50, 150);
                    ctx.fillStyle = '#8e44ad';
                    xPos += 130;
                    
                    // Limiter l'affichage pour √©viter le d√©bordement
                    if (index >= 4) return;
                });
                
                ctx.fillStyle = '#718096';
                ctx.font = '12px Arial';
                ctx.fillText('Repr√©sentation simplifi√©e - Voir d√©tails dans l\'inventaire', tempCanvas.width / 2, 220);
                
                imgData = tempCanvas.toDataURL('image/png');
                imgHeight = (tempCanvas.height * imgWidth) / tempCanvas.width;
            }
            
            // V√©rifier si on a assez de place sur la page
            if (yPosition + imgHeight > 160) {
                pdf.addPage();
                yPosition = 20;
                pdf.setFontSize(12);
                pdf.setFont(undefined, 'bold');
                pdf.text(`Page ${pageNum}/${totalPages} - Serveurs ${((pageNum-1)*serversPerPage)+1} √† ${Math.min(pageNum*serversPerPage, data.servers.length)}`, 20, yPosition);
                yPosition += 8;
            }
            
            if (imgData) {
                // Centrer l'image sur la page
                const pageWidth = pdf.internal.pageSize.width;
                const centeredX = (pageWidth - imgWidth) / 2;
                pdf.addImage(imgData, 'PNG', centeredX, yPosition, imgWidth, imgHeight);
                yPosition += imgHeight + 15;
            } else {
                pdf.setFontSize(10);
                pdf.setFont(undefined, 'italic');
                pdf.text(`Impossible de g√©n√©rer l'image pour la page ${pageNum}`, 20, yPosition);
                yPosition += 10;
            }
            
            // Ajouter une nouvelle page pour la page suivante (sauf pour la derni√®re)
            if (pageNum < totalPages) {
                pdf.addPage();
                yPosition = 20;
            }
        }
        
        // Restaurer la page originale
        currentPage = originalPage;
        serversPerPage = originalServersPerPage;
        render();
        
        // === COMMENTAIRES D'AUDIT ===
        if (pdfData.comments) {
            if (yPosition > 150) {
                pdf.addPage();
                yPosition = 20;
            }
            
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.text('OBSERVATIONS ET RECOMMANDATIONS', 20, yPosition);
            yPosition += 8;
            
            pdf.setFontSize(10);
            pdf.setFont(undefined, 'normal');
            const commentLines = pdf.splitTextToSize(pdfData.comments, 250);
            commentLines.forEach(line => {
                if (yPosition > 180) {
                    pdf.addPage();
                    yPosition = 20;
                }
                pdf.text(line, 20, yPosition);
                yPosition += 5;
            });
            yPosition += 10;
        }
        
        // === SECTION SIGNATURE ===
        if (pdfData.includeSignature) {
            if (yPosition > 120) {
                pdf.addPage();
                yPosition = 20;
            }
            
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.text('VALIDATION ET SIGNATURES', 20, yPosition);
            yPosition += 15;
            
            pdf.setFontSize(10);
            pdf.setFont(undefined, 'normal');
            
            // Tableau de signatures
            const signatureBoxes = [
                { title: 'AUDITEUR', role: 'Responsable de l\'audit' },
                { title: 'RESPONSABLE SI', role: 'Responsable S√©curit√© des SI' },
                { title: 'DIRECTION', role: 'Validation direction' }
            ];
            
            signatureBoxes.forEach((box, index) => {
                const xPos = 20 + (index * 85);
                
                // Cadre de signature
                pdf.setDrawColor(0, 0, 0);
                pdf.setLineWidth(0.3);
                pdf.rect(xPos, yPosition, 80, 40);
                
                pdf.setFont(undefined, 'bold');
                pdf.text(box.title, xPos + 2, yPosition + 5);
                pdf.setFont(undefined, 'normal');
                pdf.text(box.role, xPos + 2, yPosition + 10);
                
                pdf.text('Nom:', xPos + 2, yPosition + 20);
                pdf.text('Date:', xPos + 2, yPosition + 25);
                pdf.text('Signature:', xPos + 2, yPosition + 35);
            });
            yPosition += 50;
        }
        
        // === M√âTADONN√âES TECHNIQUES ===
        if (pdfData.includeMeta) {
            if (yPosition > 160) {
                pdf.addPage();
                yPosition = 20;
            }
            
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'bold');
            pdf.text('M√âTADONN√âES TECHNIQUES', 20, yPosition);
            yPosition += 8;
            
            pdf.setFontSize(8);
            pdf.setFont(undefined, 'normal');
            pdf.text(`G√©n√©r√© par: Cartographie ISO27001 v2.0`, 20, yPosition);
            yPosition += 4;
            pdf.text(`Hash du document: ${generateDocumentHash()}`, 20, yPosition);
            yPosition += 4;
            pdf.text(`Nombre total d'√©l√©ments trait√©s: ${data.servers.length + calculateDetailedStats().accountCount + calculateDetailedStats().identityCount}`, 20, yPosition);
        }
        
        // === PIED DE PAGE SUR TOUTES LES PAGES ===
        const pageCount = pdf.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
            pdf.setPage(i);
            pdf.setFontSize(8);
            pdf.setFont(undefined, 'normal');
            pdf.text(`${pdfData.classification} - Page ${i}/${pageCount}`, 20, 200);
            pdf.text(`G√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')} √† ${new Date().toLocaleTimeString('fr-FR')}`, 200, 200);
        }
        
        // Sauvegarder le PDF
        const fileName = `audit-iso27001-${pdfData.organization.replace(/[^a-zA-Z0-9]/g, '-')}-${new Date().toISOString().split('T')[0]}.pdf`;
        pdf.save(fileName);
        
        updateConnectionIndicator('PDF d\'audit g√©n√©r√© avec succ√®s ‚úì');
        setTimeout(() => updateConnectionIndicator('‚úì Pr√™t'), 3000);
        
        // Afficher un message de succ√®s d√©taill√©
        const successMsg = `PDF d'audit g√©n√©r√© avec succ√®s !\n\nFichier: ${fileName}\nPages: ${pageCount}\n√âl√©ments: ${data.servers.length} serveurs, ${calculateDetailedStats().accountCount} comptes, ${calculateDetailedStats().identityCount} identit√©s\n\nLe document est pr√™t pour signature et archivage.`;
        setTimeout(() => alert(successMsg), 500);
        
    } catch (error) {
        console.error('Erreur lors de la g√©n√©ration du PDF:', error);
        updateConnectionIndicator('‚ùå Erreur g√©n√©ration PDF');
        setTimeout(() => updateConnectionIndicator('‚úì Pr√™t'), 3000);
        
        const errorMsg = `Erreur lors de la g√©n√©ration du PDF:\n\n${error.message}\n\nVeuillez v√©rifier:\n‚Ä¢ Que des donn√©es sont pr√©sentes dans la cartographie\n‚Ä¢ Votre navigateur supporte les fonctions PDF\n‚Ä¢ R√©essayez dans quelques secondes`;
        alert(errorMsg);
    }
}

// Fonctions utilitaires pour le PDF
function formatDate(dateString) {
    if (!dateString) return 'Non sp√©cifi√©';
    return new Date(dateString).toLocaleDateString('fr-FR');
}

function calculateDetailedStats() {
    const serverCount = data.servers.length;
    const accountCount = data.servers.reduce((total, server) => total + server.accounts.length, 0);
    const identityCount = data.servers.reduce((total, server) => 
        total + server.accounts.reduce((acc, account) => acc + account.identities.length, 0), 0);
    
    const accountsWithIdentities = data.servers.reduce((total, server) => 
        total + server.accounts.filter(account => account.identities.length > 0).length, 0);
    
    const identityCoverage = accountCount > 0 ? Math.round((accountsWithIdentities / accountCount) * 100) : 0;
    
    // Statistiques par OS
    const osSummary = {};
    data.servers.forEach(server => {
        const os = server.os || 'Non sp√©cifi√©';
        osSummary[os] = (osSummary[os] || 0) + 1;
    });
    
    // Statistiques par type de compte
    const accountTypes = {};
    data.servers.forEach(server => {
        server.accounts.forEach(account => {
            const type = account.typeAccount || 'Non sp√©cifi√©';
            accountTypes[type] = (accountTypes[type] || 0) + 1;
        });
    });
    
    return {
        serverCount,
        accountCount,
        identityCount,
        identityCoverage,
        osSummary,
        accountTypes
    };
}

// Test de g√©n√©ration PDF simple (fonction de d√©bogage)
async function testPDFGeneration() {
    const { jsPDF } = window.jspdf;
    
    if (!window.jspdf) {
        alert(' Librairie PDF non disponible');
        return;
    }
    
    try {
        const pdf = new jsPDF();
        pdf.setFontSize(16);
        pdf.text('Test PDF - Cartographie ISO27001', 20, 20);
        pdf.setFontSize(12);
        pdf.text('Ce PDF de test confirme que la g√©n√©ration fonctionne.', 20, 40);
        pdf.text(`G√©n√©r√© le: ${new Date().toLocaleString('fr-FR')}`, 20, 60);
        
        const stats = calculateDetailedStats();
        pdf.text(`Serveurs: ${stats.serverCount}`, 20, 80);
        pdf.text(`Comptes: ${stats.accountCount}`, 20, 95);
        pdf.text(`Identit√©s: ${stats.identityCount}`, 20, 110);
        
        pdf.save('test-pdf-cartographie.pdf');
        updateConnectionIndicator('‚úÖ Test PDF r√©ussi');
        setTimeout(() => updateConnectionIndicator('‚úì Pr√™t'), 2000);
        
    } catch (error) {
        console.error('Test PDF √©chou√©:', error);
        updateConnectionIndicator('‚ùå Test PDF √©chou√©');
        alert('Test PDF √©chou√©: ' + error.message);
    }
}

// ==== Divers ====
function clearAll() { 
    if (confirm("√ätes-vous s√ªr de vouloir tout effacer ?")) { 
        data.servers = []; 
        render(); 
        updateStats();
        updateConnectionIndicator('Cartographie effac√©e');
        setTimeout(() => updateConnectionIndicator('‚úì Pr√™t'), 2000);
    } 
}

function showHelp() {
    const helpText = `üõ°Ô∏è CARTOGRAPHIE ISO27001 - GUIDE D'UTILISATION

üìã FONCTIONS PRINCIPALES:
‚Ä¢ Serveur : Cr√©ez des serveurs (rectangles violets)
‚Ä¢ Compte : Cliquez sur un serveur pour ajouter un compte (rectangles bleus)
‚Ä¢ Identit√© : Cliquez sur un compte pour ajouter une identit√© (rectangles verts)

üéÆ NAVIGATION:
‚Ä¢ Ctrl + Molette souris : Zoom avant/arri√®re
‚Ä¢ Clic + Glisser sur fond : D√©placer la vue
‚Ä¢ Clic sur n≈ìud : Ajouter un √©l√©ment enfant
‚Ä¢ Croix rouge : Supprimer l'√©l√©ment

üíæ GESTION DES DONN√âES:
‚Ä¢ Export JSON : Sauvegarde compl√®te
‚Ä¢ Import JSON : Restauration des donn√©es
‚Ä¢ Export Draw.io : Compatible avec Draw.io
‚Ä¢ G√©rer listes : Personnaliser les options

üéØ WORKFLOW RECOMMAND√â:
1. Cr√©er les serveurs principaux
2. Ajouter les comptes pour chaque serveur
3. Associer les identit√©s aux comptes
4. Sauvegarder r√©guli√®rement

‚öôÔ∏è PERSONNALISATION:
‚Ä¢ Utilisez "G√©rer listes" pour adapter les options
‚Ä¢ Les statistiques se mettent √† jour automatiquement
‚Ä¢ La sidebar peut √™tre r√©duite pour plus d'espace

Pour plus d'informations sur ISO27001, consultez la documentation officielle.`;
    
    alert(helpText);
}

// ==== Zoom & Pan (JavaScript original conserv√©) ====
let panX = 0, panY = 0, scale = 1, isPanning = false, startX, startY;
const container = document.getElementById('container');

container.addEventListener('mousedown', e => { 
    if (e.target === container || e.target === svg) {
        isPanning = true; 
        startX = e.clientX - panX; 
        startY = e.clientY - panY; 
        container.style.cursor = 'grabbing'; 
    }
});

container.addEventListener('mouseup', () => { 
    isPanning = false; 
    container.style.cursor = 'grab'; 
});

container.addEventListener('mousemove', e => {
    if (!isPanning) return;
    panX = e.clientX - startX; 
    panY = e.clientY - startY;
    svg.style.transform = `translate(${panX}px,${panY}px) scale(${scale})`;
});

container.addEventListener('wheel', e => {
    if (!e.ctrlKey) return;
    e.preventDefault();
    const rect = container.getBoundingClientRect();
    const centerX = rect.width / 2;
    const centerY = rect.height / 2;
    
    const oldScale = scale;
    scale *= e.deltaY > 0 ? 0.9 : 1.1;
    scale = Math.max(0.1, Math.min(3, scale));
    
    const scaleFactor = scale / oldScale;
    panX = centerX - (centerX - panX) * scaleFactor;
    panY = centerY - (centerY - panY) * scaleFactor;
    
    svg.style.transform = `translate(${panX}px,${panY}px) scale(${scale})`;
}, { passive: false });

// ==== NOUVELLES FONCTIONS AJOUT√âES ====

// Sidebar toggle
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const icon = document.getElementById('sidebarToggleIcon');
    
    sidebarCollapsed = !sidebarCollapsed;
    sidebar.classList.toggle('collapsed', sidebarCollapsed);
    icon.textContent = sidebarCollapsed ? '‚ñ∂' : '‚óÄ';
}

// Mise √† jour des statistiques
function updateStats() {
    const serverCount = data.servers.length;
    const accountCount = data.servers.reduce((total, server) => total + server.accounts.length, 0);
    const identityCount = data.servers.reduce((total, server) => 
        total + server.accounts.reduce((acc, account) => acc + account.identities.length, 0), 0);
    const connectionCount = accountCount + identityCount; // Connexions approximatives
    
    document.getElementById('serverCount').textContent = serverCount;
    document.getElementById('accountCount').textContent = accountCount;
    document.getElementById('identityCount').textContent = identityCount;
    document.getElementById('connectionCount').textContent = connectionCount;
}

// Indicateur de connexion
function updateConnectionIndicator(message) {
    const indicator = document.getElementById('connectionIndicator');
    indicator.textContent = message;
    
    // Animation du pulse
    indicator.style.animation = 'none';
    setTimeout(() => {
        indicator.style.animation = 'pulse 2s infinite';
    }, 10);
}

// Fonctions de zoom suppl√©mentaires
function zoomIn() {
    const event = { 
        ctrlKey: true, 
        deltaY: -100, 
        preventDefault: () => {} 
    };
    container.dispatchEvent(new WheelEvent('wheel', event));
}

function zoomOut() {
    const event = { 
        ctrlKey: true, 
        deltaY: 100, 
        preventDefault: () => {} 
    };
    container.dispatchEvent(new WheelEvent('wheel', event));
}

function resetZoom() {
    scale = 1;
    panX = 0;
    panY = 0;
    svg.style.transform = `translate(${panX}px,${panY}px) scale(${scale})`;
}

function centerView() {
    if (data.servers.length === 0) {
        updateConnectionIndicator('Aucun √©l√©ment √† centrer');
        setTimeout(() => updateConnectionIndicator('‚úì Pr√™t'), 1500);
        return;
    }
    
    // Calculer le centre approximatif du contenu
    const containerRect = container.getBoundingClientRect();
    const centerX = containerRect.width / 2;
    const centerY = containerRect.height / 2;
    
    // Approximation simple du centre du contenu
    const contentCenterX = data.servers.length * 90; // Estimation
    const contentCenterY = 200; // Estimation bas√©e sur la structure
    
    panX = centerX - contentCenterX;
    panY = centerY - contentCenterY;
    
    svg.style.transform = `translate(${panX}px,${panY}px) scale(${scale})`;
    
    updateConnectionIndicator('Vue centr√©e');
    setTimeout(() => updateConnectionIndicator('‚úì Pr√™t'), 1500);
}

// ==== FONCTIONS DE PAGINATION ====
function changePage(direction) {
    const newPage = currentPage + direction;
    if (newPage >= 1 && newPage <= maxTotalPages) {
        currentPage = newPage;
        render();
        updateStats();
        
        // Animation de feedback
        updateConnectionIndicator(`Page ${currentPage}/${maxTotalPages}`);
        setTimeout(() => updateConnectionIndicator('‚úì Pr√™t'), 1500);
        
        // Centrer la vue sur la nouvelle page
        setTimeout(() => {
            resetZoom();
            centerView();
        }, 100);
    }
}

function updatePaginationControls(currentPageServers) {
    const pageInfo = document.getElementById('pageInfo');
    const pageElementCount = document.getElementById('pageElementCount');
    const prevBtn = document.getElementById('prevPageBtn');
    const nextBtn = document.getElementById('nextPageBtn');
    
    if (pageInfo) {
        pageInfo.textContent = `${currentPage}/${maxTotalPages}`;
    }
    
    if (pageElementCount) {
        pageElementCount.textContent = `${currentPageServers} serveur${currentPageServers > 1 ? 's' : ''} affich√©${currentPageServers > 1 ? 's' : ''}`;
    }
    
    if (prevBtn) {
        prevBtn.disabled = currentPage <= 1;
        prevBtn.style.opacity = currentPage <= 1 ? '0.5' : '1';
    }
    
    if (nextBtn) {
        nextBtn.disabled = currentPage >= maxTotalPages;
        nextBtn.style.opacity = currentPage >= maxTotalPages ? '0.5' : '1';
    }
}

// Fonction pour aller √† une page sp√©cifique
function goToPage(pageNumber) {
    if (pageNumber >= 1 && pageNumber <= maxTotalPages) {
        currentPage = pageNumber;
        render();
        updateStats();
    }
}

// Fonction pour ajuster le nombre de serveurs par page
function setServersPerPage(count) {
    serversPerPage = Math.max(1, count);
    currentPage = 1; // Retour √† la premi√®re page
    render();
    updateStats();
}

// Gestion des √©v√©nements du redimensionnement
window.addEventListener('resize', () => {
    render();
    updateStats();
});

// Fermer les modales en cliquant √† l'ext√©rieur
document.addEventListener('click', (e) => {
    if (e.target.classList.contains('modal')) {
        e.target.style.display = 'none';
    }
});

// Gestion des raccourcis clavier
document.addEventListener('keydown', (e) => {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
        return;
    }
    
    switch(e.key) {
        case 'Escape':
            // Fermer toutes les modales
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
            break;
        case 'h':
        case 'H':
            showHelp();
            break;
        case 's':
        case 'S':
            if (e.ctrlKey) {
                e.preventDefault();
                exportJSON();
            }
            break;
    }
});

// Initialisation
window.addEventListener('load', () => {
    render();
    updateStats();
    updateConnectionIndicator('‚úì Application pr√™te');
    
    // V√©rifier les librairies PDF
    checkPDFLibraries();
    
    // Masquer l'aide apr√®s quelques secondes
    setTimeout(() => {
        const helpTooltip = document.querySelector('.help-tooltip');
        if (helpTooltip) {
            helpTooltip.style.opacity = '0';
            setTimeout(() => {
                helpTooltip.style.display = 'none';
            }, 500);
        }
    }, 10000);
});

// V√©rification des librairies PDF
function checkPDFLibraries() {
    const systemStatus = document.getElementById('systemStatus');
    const libStatus = document.getElementById('libStatus');
    
    if (systemStatus && libStatus) {
        let status = '‚úÖ Syst√®me op√©rationnel';
        let libStatusText = '';
        
        if (window.jspdf) {
            libStatusText += '‚úÖ jsPDF ';
        } else {
            libStatusText += '‚ùå jsPDF ';
            status = '‚ö†Ô∏è Librairies manquantes';
        }
        
        if (window.html2canvas) {
            libStatusText += '‚úÖ html2canvas';
        } else {
            libStatusText += '‚ùå html2canvas';
            status = '‚ö†Ô∏è Librairies manquantes';
        }
        
        systemStatus.textContent = status;
        libStatus.textContent = libStatusText;
        
        if (status.includes('manquantes')) {
            setTimeout(() => {
                systemStatus.innerHTML = '‚ö†Ô∏è Rechargez la page<br>si PDF ne fonctionne pas';
            }, 3000);
        }
    }
}

function generateDocumentHash() {
    // G√©n√©ration d'un hash simple bas√© sur le contenu
    const content = JSON.stringify(data) + new Date().toDateString();
    let hash = 0;
    for (let i = 0; i < content.length; i++) {
        const char = content.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convertir en 32bit integer
    }
    return Math.abs(hash).toString(16).toUpperCase();
}

// ==== MENU CONTEXTUEL ====
function showContextMenu(elementType, serverId, accountId, identityId, x, y) {
    const existingMenu = document.getElementById('contextMenu');
    if (existingMenu) {
        existingMenu.remove();
    }
    
    const menu = document.createElement('div');
    menu.id = 'contextMenu';
    menu.style.cssText = `
        position: absolute;
        background: white;
        border: 2px solid var(--primary);
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1000;
        min-width: 200px;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    `;
    
    // Use direct mouse coordinates for better positioning
    menu.style.left = (x + 10) + 'px';
    menu.style.top = (y - 10) + 'px';
    
    const options = [];
    
    if (elementType === 'server') {
        options.push({ text: '‚úèÔ∏è Modifier ce serveur', action: () => openEditServerModal(serverId) });
        options.push({ text: '‚ûï Ajouter un compte', action: () => openAddAccountModal(serverId) });
    } else if (elementType === 'account') {
        options.push({ text: '‚úèÔ∏è Modifier ce compte', action: () => openEditAccountModal(serverId, accountId) });
        options.push({ text: '‚ûï Ajouter une identit√©', action: () => openAddIdentityModal(serverId, accountId) });
    } else if (elementType === 'identity') {
        options.push({ text: '‚úèÔ∏è Modifier cette identit√©', action: () => openEditIdentityModal(serverId, accountId, identityId) });
        options.push({ text: '‚ûï Ajouter une autre identit√©', action: () => openAddIdentityModal(serverId, accountId) });
    }
    
    options.forEach((option, index) => {
        const button = document.createElement('button');
        button.textContent = option.text;
        button.style.cssText = `
            display: block;
            width: 100%;
            padding: 12px 16px;
            border: none;
            background: ${index === 0 ? 'var(--primary)' : 'white'};
            color: ${index === 0 ? 'white' : 'var(--dark)'};
            text-align: left;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
            ${index === 0 ? 'border-radius: 6px 6px 0 0;' : ''}
            ${index === options.length - 1 ? 'border-radius: 0 0 6px 6px;' : ''}
        `;
        
        button.addEventListener('mouseenter', () => {
            if (index !== 0) {
                button.style.background = '#f8f9fa';
            }
        });
        
        button.addEventListener('mouseleave', () => {
            if (index !== 0) {
                button.style.background = 'white';
            }
        });
        
        button.addEventListener('click', () => {
            option.action();
            menu.remove();
        });
        
        menu.appendChild(button);
        
        if (index < options.length - 1) {
            const separator = document.createElement('div');
            separator.style.cssText = 'height: 1px; background: #e2e8f0; margin: 0;';
            menu.appendChild(separator);
        }
    });
    
    document.body.appendChild(menu);
    
    // Prevent menu from going off-screen
    const menuRect = menu.getBoundingClientRect();
    const windowWidth = window.innerWidth;
    const windowHeight = window.innerHeight;
    
    // Adjust horizontal position if menu would go off right edge
    if (menuRect.right > windowWidth) {
        menu.style.left = (x - menuRect.width - 10) + 'px';
    }
    
    // Adjust vertical position if menu would go off bottom edge
    if (menuRect.bottom > windowHeight) {
        menu.style.top = (y - menuRect.height - 10) + 'px';
    }
    
    const closeMenu = (e) => {
        if (!menu.contains(e.target)) {
            menu.remove();
            document.removeEventListener('click', closeMenu);
        }
    };
    
    setTimeout(() => {
        document.addEventListener('click', closeMenu);
    }, 100);
}

// Menu contextuel pour zone vide
function showEmptyAreaContextMenu(x, y) {
    const existingMenu = document.getElementById('contextMenu');
    if (existingMenu) {
        existingMenu.remove();
    }
    
    const menu = document.createElement('div');
    menu.id = 'contextMenu';
    menu.style.cssText = `
        position: absolute;
        background: white;
        border: 2px solid var(--primary);
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1000;
        min-width: 200px;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    `;
    
    const container = document.getElementById('container');
    const rect = container.getBoundingClientRect();
    menu.style.left = (rect.left + x + 20) + 'px';
    menu.style.top = (rect.top + y - 10) + 'px';
    
    const options = [
        { text: 'üñ•Ô∏è Ajouter un serveur', action: () => openAddServerModal() }
    ];
    
    options.forEach((option, index) => {
        const button = document.createElement('button');
        button.textContent = option.text;
        button.style.cssText = `
            display: block;
            width: 100%;
            padding: 12px 16px;
            border: none;
            background: var(--primary);
            color: white;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            border-radius: 6px;
            transition: all 0.2s ease;
        `;
        
        button.addEventListener('mouseenter', () => {
            button.style.background = 'var(--primary-dark)';
        });
        
        button.addEventListener('mouseleave', () => {
            button.style.background = 'var(--primary)';
        });
        
        button.addEventListener('click', () => {
            option.action();
            menu.remove();
        });
        
        menu.appendChild(button);
    });
    
    // Fermer le menu en cliquant ailleurs
    const closeMenu = (e) => {
        if (!menu.contains(e.target)) {
            menu.remove();
            document.removeEventListener('click', closeMenu);
        }
    };
    
    setTimeout(() => {
        document.addEventListener('click', closeMenu);
    }, 10);
    
    document.body.appendChild(menu);
}

console.log('Cartographie ISO27001 - Version am√©lior√©e avec menu contextuel initialis√©e');
</script>

</body>
</html>
